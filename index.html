<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>ì•„íŠ¸ ì˜¤ë¸Œ ì›Œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    <style>
      body {
        overscroll-behavior: none;
        user-select: none;
        -webkit-user-select: none;
        font-family: 'Roboto', sans-serif;
        background-color: #1a202c;
      }
      .font-display {
        font-family: 'Black Ops One', cursive;
      }
      .perspective-container {
        perspective: 1000px;
        overflow: visible;
      }
      .battle-grid {
        transform: rotateX(30deg) scale(0.9);
        transform-style: preserve-3d;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }
      /* Hide scrollbar */
      ::-webkit-scrollbar {
        width: 0px;
        background: transparent;
      }
      @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
      }
      .animate-pop {
        animation: pop 0.2s ease-in-out;
      }
      .animate-float {
        animation: float 3s ease-in-out infinite;
      }
      @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react-dom/client": "https://aistudiocdn.com/react-dom@^19.2.0/client",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
  <body class="bg-slate-900 text-white overflow-hidden h-screen w-screen fixed inset-0">
    <div id="root" class="w-full h-full"></div>

    <script type="text/babel" data-type="module" data-presets="react,typescript">
    import React, { useState, useEffect, useRef, useCallback, useMemo } from 'react';
    import ReactDOM from 'react-dom/client';
    import { Coins, Swords, RefreshCw, Trophy, Skull, Gift, Activity, HelpCircle, X, MousePointer2, Shield, Crosshair, Percent, Heart, Zap, Move, Target, ShoppingCart, Package, Gem, Lock, Sparkles, Crown, Medal, Users, Clover, Trash2, CheckCircle2, Scroll, Flame, AlertTriangle, Hammer, ArrowUpCircle } from 'lucide-react';

    // --- TYPES & CONSTANTS ---
    const UnitType = {
      INFANTRY: 'INFANTRY',
      ARCHER: 'ARCHER',
      TANK: 'TANK',
      SPEARMAN: 'SPEARMAN',
      MAGE: 'MAGE',
      ASSASSIN: 'ASSASSIN',
      GOLEM: 'GOLEM',
      DRAGON: 'DRAGON',
      PALADIN: 'PALADIN',
      SNIPER: 'SNIPER',
      VOID_WALKER: 'VOID_WALKER'
    };

    const UnitTier = {
      COMMON: 'COMMON',
      RARE: 'RARE',
      EPIC: 'EPIC',
      LEGENDARY: 'LEGENDARY',
      MYTHIC: 'MYTHIC'
    };

    const Side = {
      PLAYER: 'PLAYER',
      ENEMY: 'ENEMY'
    };

    const Difficulty = {
      NORMAL: 'NORMAL',
      HARD: 'HARD',
      HELL: 'HELL'
    };

    const GamePhase = {
      DIFFICULTY_SELECT: 'DIFFICULTY_SELECT',
      PREPARATION: 'PREPARATION',
      BATTLE: 'BATTLE',
      VICTORY: 'VICTORY',
      DEFEAT: 'DEFEAT',
      GAME_CLEAR: 'GAME_CLEAR'
    };

    const ArtifactType = {
      HOLY_SWORD: 'HOLY_SWORD',      // Damage +5%
      ANCIENT_SHIELD: 'ANCIENT_SHIELD', // HP +5%
      WAR_DRUMS: 'WAR_DRUMS',        // Attack Speed +3%
      WIND_CLOAK: 'WIND_CLOAK',      // Move Speed +5%
      MIDAS_TOUCH: 'MIDAS_TOUCH',    // Gold Gain +10%
    };

    const GlobalTechType = {
      CAPACITY: 'CAPACITY', // Increase Max Unit Count
      LUCK: 'LUCK',         // Increase High Tier Summon Rate
      MYTHIC_MASTERY: 'MYTHIC_MASTERY', // Boost Mythic Unit Stats
    };

    // --- CONFIGURATION ---
    const GRID_ROWS = 8;
    const GRID_COLS = 7;
    const TILE_SIZE = 50; 

    const TIER_INFO = {
      [UnitTier.COMMON]: { name: 'ì¼ë°˜', color: 'text-gray-400', borderColor: 'border-gray-400', costMult: 1.0 },
      [UnitTier.RARE]: { name: 'í¬ê·€', color: 'text-blue-400', borderColor: 'border-blue-500', costMult: 3.0 },
      [UnitTier.EPIC]: { name: 'ì˜ì›…', color: 'text-purple-400', borderColor: 'border-purple-500', costMult: 8.0 },
      [UnitTier.LEGENDARY]: { name: 'ì „ì„¤', color: 'text-yellow-400', borderColor: 'border-yellow-400', costMult: 20.0 },
      [UnitTier.MYTHIC]: { name: 'ì‹ í™”', color: 'text-red-500', borderColor: 'border-red-500', costMult: 50.0 },
    };

    const DIFFICULTY_SETTINGS = {
      [Difficulty.NORMAL]: {
        name: 'ë³´í†µ',
        maxLevel: 30,
        enemyMult: 0.8, 
        desc: '30ë‹¨ê³„. ê¸°ë³¸ì ì¸ ì „ëµì„ ìµíˆê¸°ì— ì í•©í•©ë‹ˆë‹¤.',
        color: 'text-green-400'
      },
      [Difficulty.HARD]: {
        name: 'í•˜ë“œ',
        maxLevel: 40,
        enemyMult: 1.0, 
        desc: '40ë‹¨ê³„. ë” ê°•ë ¥í•œ ì ë“¤ì´ ë“±ì¥í•©ë‹ˆë‹¤.',
        color: 'text-orange-400'
      },
      [Difficulty.HELL]: {
        name: 'ì§€ì˜¥',
        maxLevel: 50,
        enemyMult: 1.2, 
        desc: '50ë‹¨ê³„. ê·¹í•œì˜ ë‚œì´ë„ì— ë„ì „í•˜ì„¸ìš”.',
        color: 'text-red-600'
      }
    };

    const UNIT_NAMES = {
      [UnitType.INFANTRY]: 'ë³´ë³‘',
      [UnitType.ARCHER]: 'ê¶ìˆ˜',
      [UnitType.TANK]: 'íƒ±í¬',
      [UnitType.SPEARMAN]: 'ì°½ë³‘',
      [UnitType.MAGE]: 'ë§ˆë²•ì‚¬',
      [UnitType.ASSASSIN]: 'ì•”ì‚´ì',
      [UnitType.GOLEM]: 'ê³¨ë ˜',
      [UnitType.DRAGON]: 'ë“œë˜ê³¤',
      [UnitType.PALADIN]: 'ì‹ ì„± ê¸°ì‚¬',
      [UnitType.SNIPER]: 'ì €ê²©ìˆ˜',
      [UnitType.VOID_WALKER]: 'ê³µí—ˆ ë°©ë‘ì',
    };

    const UNIT_BASE_STATS = {
      [UnitType.INFANTRY]: { tier: UnitTier.COMMON, hp: 120, damage: 15, attackSpeed: 1.2, range: 1.2, moveSpeed: 2.5, color: 'bg-slate-600', icon: 'âš”ï¸' },
      [UnitType.ARCHER]: { tier: UnitTier.COMMON, hp: 80, damage: 25, attackSpeed: 1.0, range: 5.5, moveSpeed: 2.2, color: 'bg-slate-600', icon: 'ğŸ¹' },
      [UnitType.TANK]: { tier: UnitTier.RARE, hp: 300, damage: 12, attackSpeed: 0.8, range: 1.2, moveSpeed: 1.8, color: 'bg-blue-700', icon: 'ğŸ›¡ï¸' },
      [UnitType.SPEARMAN]: { tier: UnitTier.RARE, hp: 150, damage: 22, attackSpeed: 1.1, range: 2.5, moveSpeed: 2.3, color: 'bg-blue-700', icon: 'ğŸ”±' },
      [UnitType.MAGE]: { tier: UnitTier.EPIC, hp: 90, damage: 45, attackSpeed: 0.7, range: 6.0, moveSpeed: 2.0, color: 'bg-purple-700', icon: 'ğŸ§™' },
      [UnitType.ASSASSIN]: { tier: UnitTier.EPIC, hp: 140, damage: 40, attackSpeed: 2.0, range: 1.2, moveSpeed: 3.5, color: 'bg-purple-700', icon: 'ğŸ¥·' },
      [UnitType.GOLEM]: { tier: UnitTier.LEGENDARY, hp: 600, damage: 25, attackSpeed: 0.6, range: 1.2, moveSpeed: 1.5, color: 'bg-yellow-700', icon: 'ğŸ—¿' },
      [UnitType.DRAGON]: { tier: UnitTier.LEGENDARY, hp: 400, damage: 70, attackSpeed: 0.9, range: 3.5, moveSpeed: 2.5, color: 'bg-yellow-700', icon: 'ğŸ‰' },
      [UnitType.PALADIN]: { tier: UnitTier.MYTHIC, hp: 2000, damage: 100, attackSpeed: 1.0, range: 1.2, moveSpeed: 2.0, color: 'bg-red-900', icon: 'âšœï¸' },
      [UnitType.SNIPER]: { tier: UnitTier.MYTHIC, hp: 350, damage: 400, attackSpeed: 0.6, range: 8.0, moveSpeed: 1.5, color: 'bg-red-900', icon: 'ğŸ¯' },
      [UnitType.VOID_WALKER]: { tier: UnitTier.MYTHIC, hp: 1000, damage: 150, attackSpeed: 1.6, range: 3.0, moveSpeed: 2.5, color: 'bg-red-900', icon: 'ğŸ‘¾' }
    };

    const HP_MULTIPLIER = 1.8; 
    const DAMAGE_MULTIPLIER = 1.6;
    const ENEMY_COLOR = 'bg-red-600';
    const RECRUIT_COST = 100;
    const RECRUIT_COST_INCREASE = 10;
    const TECH_COST_BASE = 100;
    const TECH_COST_INCREASE = 20;
    const BASE_UNIT_CAP = 10;
    const UNIT_CAP_PER_LEVEL = 2;
    const ARTIFACT_COST_BASE = 200;
    const ARTIFACT_COST_INCREASE = 50;

    const GLOBAL_TECH_INFO = {
      [GlobalTechType.CAPACITY]: { name: "ë³‘ì˜ í™•ì¥", desc: "ìµœëŒ€ ë³´ìœ  ìœ ë‹› ìˆ˜ê°€ ì¦ê°€í•©ë‹ˆë‹¤.", baseCost: 200, costInc: 100, maxLevel: 20 },
      [GlobalTechType.LUCK]: { name: "í–‰ìš´ì˜ ë¶€ì ", desc: "ë†’ì€ ë“±ê¸‰ì˜ ìœ ë‹›ì´ ë“±ì¥í•  í™•ë¥ ì´ ì¦ê°€í•©ë‹ˆë‹¤.", baseCost: 200, costInc: 100, maxLevel: 10 },
      [GlobalTechType.MYTHIC_MASTERY]: { name: "ì‹ í™” ë§ˆìŠ¤í„°ë¦¬", desc: "ëª¨ë“  ì‹ í™” ë“±ê¸‰ ìœ ë‹›ì˜ ëŠ¥ë ¥ì¹˜ê°€ ê°•í™”ë©ë‹ˆë‹¤.", baseCost: 200, costInc: 20, maxLevel: 100 }
    };

    const ARTIFACT_INFO = {
      [ArtifactType.HOLY_SWORD]: { name: "ì„±ìŠ¤ëŸ¬ìš´ ê²€", desc: "ëª¨ë“  ì•„êµ° ìœ ë‹›ì˜ ê³µê²©ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤.", icon: "ğŸ—¡ï¸", perLevel: "+5%" },
      [ArtifactType.ANCIENT_SHIELD]: { name: "ê³ ëŒ€ ë°©íŒ¨", desc: "ëª¨ë“  ì•„êµ° ìœ ë‹›ì˜ ì²´ë ¥ì´ ì¦ê°€í•©ë‹ˆë‹¤.", icon: "ğŸ›¡ï¸", perLevel: "+5%" },
      [ArtifactType.WAR_DRUMS]: { name: "ì „ìŸì˜ ë¶", desc: "ëª¨ë“  ì•„êµ° ìœ ë‹›ì˜ ê³µê²© ì†ë„ê°€ ë¹¨ë¼ì§‘ë‹ˆë‹¤.", icon: "ğŸ¥", perLevel: "+3%" },
      [ArtifactType.WIND_CLOAK]: { name: "ë°”ëŒì˜ ë§í† ", desc: "ëª¨ë“  ì•„êµ° ìœ ë‹›ì˜ ì´ë™ ì†ë„ê°€ ë¹¨ë¼ì§‘ë‹ˆë‹¤.", icon: "ğŸƒ", perLevel: "+5%" },
      [ArtifactType.MIDAS_TOUCH]: { name: "ë¯¸ë‹¤ìŠ¤ì˜ ì†", desc: "ì „íˆ¬ ìŠ¹ë¦¬ ë° ë³´ê¸‰ ì‹œ íšë“í•˜ëŠ” ê³¨ë“œê°€ ì¦ê°€í•©ë‹ˆë‹¤.", icon: "ğŸ–ï¸", perLevel: "+10%" }
    };

    const ACHIEVEMENTS = [
      { id: 'kill_1', title: "ì²« ë²ˆì§¸ í”¼", desc: "ì  ìœ ë‹› 1ë§ˆë¦¬ ì²˜ì¹˜", type: 'kills', target: 1, reward: 100, icon: "ğŸ©¸" },
      { id: 'kill_100', title: "ì „ì¥ì˜ í•™ì‚´ì", desc: "ì  ìœ ë‹› 100ë§ˆë¦¬ ì²˜ì¹˜", type: 'kills', target: 100, reward: 500, icon: "ğŸ’€" },
      { id: 'kill_1000', title: "ì „ìŸì˜ ì‹ ", desc: "ì  ìœ ë‹› 1,000ë§ˆë¦¬ ì²˜ì¹˜", type: 'kills', target: 1000, reward: 2000, icon: "ğŸ‘¹" },
      { id: 'merge_10', title: "í•©ì„±ì˜ ì‹œì‘", desc: "ìœ ë‹› 10íšŒ í•©ì„±", type: 'merges', target: 10, reward: 200, icon: "âœ¨" },
      { id: 'merge_100', title: "ì—°ê¸ˆìˆ ì‚¬", desc: "ìœ ë‹› 100íšŒ í•©ì„±", type: 'merges', target: 100, reward: 1000, icon: "âš—ï¸" },
      { id: 'summon_50', title: "ì§•ì§‘ê´€", desc: "ìœ ë‹› 50íšŒ ì†Œí™˜", type: 'summons', target: 50, reward: 300, icon: "ğŸ“¦" },
      { id: 'summon_200', title: "êµ°ë‹¨ì¥", desc: "ìœ ë‹› 200íšŒ ì†Œí™˜", type: 'summons', target: 200, reward: 1500, icon: "ğŸ°" },
      { id: 'win_10', title: "ìŠ¹ë¦¬ì˜ ë§›", desc: "ì „íˆ¬ 10íšŒ ìŠ¹ë¦¬", type: 'wins', target: 10, reward: 400, icon: "ğŸš©" },
      { id: 'win_50', title: "ì •ë³µì", desc: "ì „íˆ¬ 50íšŒ ìŠ¹ë¦¬", type: 'wins', target: 50, reward: 2500, icon: "ğŸ‘‘" },
    ];

    const SYNTHESIS_RECIPES = [
      { id: 'paladin', result: UnitType.PALADIN, ingredients: [UnitType.INFANTRY, UnitType.TANK], minLevel: 3, cost: 500 },
      { id: 'sniper', result: UnitType.SNIPER, ingredients: [UnitType.ARCHER, UnitType.SPEARMAN], minLevel: 3, cost: 500 },
      { id: 'void_walker', result: UnitType.VOID_WALKER, ingredients: [UnitType.MAGE, UnitType.GOLEM], minLevel: 3, cost: 500 }
    ];

    // --- GAME LOGIC SERVICES ---
    const getUnitStats = (type, level, techLevel = 1, artifactLevels = {}) => {
      const base = UNIT_BASE_STATS[type];
      const techMult = 1 + ((techLevel - 1) * 0.2);
      const swordLvl = artifactLevels[ArtifactType.HOLY_SWORD] || 0;
      const damageMult = 1 + (swordLvl * 0.05);
      const shieldLvl = artifactLevels[ArtifactType.ANCIENT_SHIELD] || 0;
      const hpMult = 1 + (shieldLvl * 0.05);
      const drumLvl = artifactLevels[ArtifactType.WAR_DRUMS] || 0;
      const atkSpeedMult = 1 + (drumLvl * 0.03);
      const cloakLvl = artifactLevels[ArtifactType.WIND_CLOAK] || 0;
      const moveSpeedMult = 1 + (cloakLvl * 0.05);

      return {
        ...base,
        hp: Math.floor(base.hp * Math.pow(HP_MULTIPLIER, level - 1) * techMult * hpMult),
        damage: Math.floor(base.damage * Math.pow(DAMAGE_MULTIPLIER, level - 1) * techMult * damageMult),
        attackSpeed: Number((base.attackSpeed * atkSpeedMult).toFixed(2)),
        moveSpeed: Number((base.moveSpeed * moveSpeedMult).toFixed(2)),
        range: base.range,
        color: base.color,
        icon: base.icon
      };
    };

    const createEntity = (type, level, side, gridX, gridY, techLevel = 1, artifactLevels = {}) => {
      const stats = getUnitStats(type, level, techLevel, artifactLevels);
      return {
        id: Math.random().toString(36).substr(2, 9),
        type, level, side, gridX, gridY, x: gridX, y: gridY,
        hp: stats.hp, maxHp: stats.hp, lastAttackTime: 0, targetId: null, state: 'IDLE', facingRight: side === Side.PLAYER 
      };
    };

    const getDistance = (e1, e2) => {
      const dx = e1.x - e2.x;
      const dy = e1.y - e2.y;
      return Math.sqrt(dx * dx + dy * dy);
    };

    const findNearestTarget = (me, allEntities) => {
      let nearest = null;
      let minDist = Infinity;
      for (const other of allEntities) {
        if (other.side !== me.side && other.hp > 0) {
          const dist = getDistance(me, other);
          if (dist < minDist) {
            minDist = dist;
            nearest = other;
          }
        }
      }
      return nearest;
    };

    // --- LEVEL GENERATION ---
    const generateLevel = async (levelNumber, difficulty) => {
      const diffSetting = DIFFICULTY_SETTINGS[difficulty];
      const enemyMaxRow = Math.floor(GRID_ROWS / 2) - 1;
      let availableTypes = [UnitType.INFANTRY, UnitType.ARCHER];
      if (levelNumber > 3) availableTypes.push(UnitType.TANK, UnitType.SPEARMAN);
      if (levelNumber > 6) availableTypes.push(UnitType.MAGE, UnitType.ASSASSIN);
      if (levelNumber > 10) availableTypes.push(UnitType.GOLEM, UnitType.DRAGON);

      let baseCount = 2 + Math.floor(levelNumber / 4.0);
      if (difficulty === Difficulty.HELL) baseCount += 1 + Math.floor(levelNumber / 5);
      else if (difficulty === Difficulty.HARD) baseCount += Math.floor(levelNumber / 10);
      const count = Math.min(baseCount, 16); 
      
      const enemies = [];
      const occupied = new Set();
      for (let i = 0; i < count; i++) {
        let gridX = 0, gridY = 0, attempts = 0;
        do {
          gridX = Math.floor(Math.random() * GRID_COLS);
          gridY = Math.floor(Math.random() * (enemyMaxRow + 1));
          attempts++;
        } while (occupied.has(`${gridX},${gridY}`) && attempts < 20);

        if (attempts < 20) {
          occupied.add(`${gridX},${gridY}`);
          const type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
          let enemyLevel = 1;
          if (difficulty === Difficulty.NORMAL) enemyLevel = 1 + Math.floor(levelNumber / 8); 
          else if (difficulty === Difficulty.HARD) enemyLevel = 1 + Math.floor(levelNumber / 6); 
          else enemyLevel = 2 + Math.floor(levelNumber / 5); 

          enemies.push({ type, level: enemyLevel, side: Side.ENEMY, gridX, gridY });
        }
      }
      await new Promise(resolve => setTimeout(resolve, 300));
      return { levelNumber, enemies };
    };

    // --- COMPONENTS ---
    // Unit.tsx
    const Unit = ({ entity, tileSize, style, isDragging, onMouseDown, onTouchStart, showHealth }) => {
      const stats = UNIT_BASE_STATS[entity.type];
      const tierInfo = TIER_INFO[stats.tier];
      const isEnemy = entity.side === Side.ENEMY;
      const bgColor = isEnemy ? ENEMY_COLOR : stats.color;
      const size = tileSize * 0.9;
      const stars = useMemo(() => Array.from({ length: entity.level }).map((_, i) => <span key={i} className="text-[10px] text-yellow-300 drop-shadow-md">â˜…</span>), [entity.level]);
      const hpPercent = (entity.hp / entity.maxHp) * 100;
      const rotation = entity.facingRight ? 'scale-x-[-1]' : 'scale-x-[1]';
      const borderColorClass = isEnemy ? 'border-red-800' : tierInfo.borderColor;

      let glowClass = 'shadow-[inset_0_2px_4px_rgba(255,255,255,0.3)]';
      if (!isEnemy) {
          if (stats.tier === UnitTier.MYTHIC) glowClass = 'shadow-[0_0_20px_rgba(239,68,68,0.9),0_0_40px_rgba(239,68,68,0.5)] ring-2 ring-red-400 animate-pulse z-20';
          else if (stats.tier === UnitTier.LEGENDARY) glowClass = 'shadow-[0_0_15px_rgba(234,179,8,0.8)]';
          else if (stats.tier === UnitTier.EPIC) glowClass = 'shadow-[0_0_10px_rgba(168,85,247,0.6)]';
      }

      return (
        <div onMouseDown={onMouseDown} onTouchStart={onTouchStart} data-grid-x={entity.gridX} data-grid-y={entity.gridY} data-unit-id={entity.id} data-side={entity.side}
          className={`absolute transition-transform will-change-transform ${isDragging ? 'z-50 cursor-grabbing' : 'z-10 cursor-grab'} ${entity.state === 'DEAD' ? 'opacity-0 scale-0' : 'opacity-100'}`}
          style={{ width: size, height: size, ...style, transition: isDragging ? 'none' : 'left 0.1s linear, top 0.1s linear, transform 0.2s ease, opacity 0.3s ease' }}>
          <div className="absolute top-1 left-0 w-full h-full bg-black/40 rounded-lg transform translate-y-1 scale-95 blur-sm pointer-events-none" />
          <div className={`relative w-full h-full rounded-xl border-2 ${borderColorClass} flex flex-col items-center justify-center select-none ${glowClass} ${bgColor} ${entity.state === 'ATTACKING' ? 'animate-pop' : ''}`}>
            <div className={`text-2xl filter drop-shadow-lg transform transition-transform duration-200 ${rotation} pointer-events-none`}>{stats.icon}</div>
            <div className="absolute -top-2 -right-2 bg-slate-800 border border-white/20 rounded-md px-1 min-w-[20px] h-5 flex items-center justify-center shadow-lg overflow-hidden pointer-events-none">
              <div className="flex space-x-[-2px]">{stars}</div>
            </div>
            <div className="absolute -bottom-1 -left-1 bg-white/20 text-[10px] font-bold px-1.5 rounded-sm backdrop-blur-sm pointer-events-none">Lv.{entity.level}</div>
            {showHealth && (
              <div className="absolute -bottom-3 w-[110%] h-2 bg-gray-800 rounded-full overflow-hidden border border-black/50 shadow-sm z-20 pointer-events-none">
                <div className={`h-full transition-all duration-200 ${isEnemy ? 'bg-red-500' : 'bg-green-400'}`} style={{ width: `${Math.max(0, hpPercent)}%` }} />
              </div>
            )}
          </div>
        </div>
      );
    };

    const StoreCard = ({ cost, onBuy, canAfford, unitCount }) => {
      return (
        <div onClick={() => onBuy()} className={`relative group cursor-pointer w-20 h-24 sm:w-24 sm:h-28 bg-gradient-to-b from-blue-600 to-blue-800 rounded-xl shadow-xl border-2 sm:border-4 border-blue-400 flex flex-col items-center justify-center transform transition-all active:scale-95 hover:scale-105`}>
          <div className="text-3xl sm:text-4xl mb-1 sm:mb-2 drop-shadow-lg group-hover:animate-bounce">ğŸ“¦</div>
          <div className="font-bold text-white text-[10px] sm:text-xs uppercase tracking-wider">ìƒì </div>
          <div className="absolute -bottom-2 sm:-bottom-3 bg-yellow-500 text-black font-extrabold px-2 sm:px-3 py-0.5 sm:py-1 rounded-full border-2 border-white shadow-md flex items-center gap-1 scale-90 sm:scale-100">
            <span className="text-[10px] sm:text-xs">ğŸª™</span><span className="text-xs sm:text-sm">{cost}</span>
          </div>
          <div className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] sm:text-xs font-bold w-5 h-5 sm:w-6 sm:h-6 rounded-full flex items-center justify-center border-2 border-white">{unitCount}</div>
        </div>
      );
    };

    const UpgradeCard = ({ onOpen, hasUpgradable }) => {
      return (
        <div onClick={onOpen} className={`relative group cursor-pointer w-20 h-24 sm:w-24 sm:h-28 bg-gradient-to-b from-purple-600 to-purple-800 rounded-xl shadow-xl border-2 sm:border-4 border-purple-400 flex flex-col items-center justify-center transform transition-all active:scale-95 hover:scale-105`}>
          <div className="text-3xl sm:text-4xl mb-1 sm:mb-2 drop-shadow-lg text-white group-hover:rotate-12 transition-transform"><Hammer size={32} className="sm:w-10 sm:h-10" /></div>
          <div className="font-bold text-white text-[10px] sm:text-xs uppercase tracking-wider">ì—°êµ¬ì†Œ</div>
          <div className="absolute -bottom-2 sm:-bottom-3 bg-purple-900 text-white font-extrabold px-2 sm:px-3 py-0.5 sm:py-1 rounded-full border-2 border-purple-300 shadow-md flex items-center gap-1 text-[10px] sm:text-xs scale-90 sm:scale-100">ê°•í™”í•˜ê¸°</div>
          {hasUpgradable && <div className="absolute -top-2 -right-2 bg-green-500 text-white w-5 h-5 sm:w-6 sm:h-6 rounded-full flex items-center justify-center border-2 border-white animate-bounce"><ArrowUpCircle size={14} className="sm:w-4 sm:h-4" /></div>}
        </div>
      );
    };

    const ArtifactCard = ({ onOpen }) => {
      return (
        <div onClick={onOpen} className={`relative group cursor-pointer w-20 h-24 sm:w-24 sm:h-28 bg-gradient-to-b from-yellow-700 to-yellow-900 rounded-xl shadow-xl border-2 sm:border-4 border-yellow-500 flex flex-col items-center justify-center transform transition-all active:scale-95 hover:scale-105 overflow-hidden`}>
          <div className="absolute inset-0 bg-white/10 skew-x-12 translate-x-[-150%] group-hover:animate-[shine_1s_infinite]"></div>
          <div className="text-3xl sm:text-4xl mb-1 sm:mb-2 drop-shadow-lg text-yellow-200"><Gem size={32} className="sm:w-10 sm:h-10" /></div>
          <div className="font-bold text-yellow-100 text-[10px] sm:text-xs uppercase tracking-wider">ìœ ë¬¼</div>
          <div className="absolute -bottom-2 bg-black/40 w-full h-4"></div>
        </div>
      );
    };

    const AltarCard = ({ onOpen }) => {
      return (
        <div onClick={onOpen} className={`relative group cursor-pointer w-20 h-24 sm:w-24 sm:h-28 bg-gradient-to-b from-red-900 to-black rounded-xl shadow-xl border-2 sm:border-4 border-red-500 flex flex-col items-center justify-center transform transition-all active:scale-95 hover:scale-105 overflow-hidden`}>
          <div className="absolute inset-0 bg-red-500/10 animate-pulse"></div>
          <div className="text-3xl sm:text-4xl mb-1 sm:mb-2 drop-shadow-lg text-red-200 z-10 group-hover:-translate-y-1 transition-transform"><Scroll size={32} className="sm:w-10 sm:h-10" /></div>
          <div className="font-bold text-red-100 text-[10px] sm:text-xs uppercase tracking-wider z-10">ì œë‹¨</div>
          <div className="absolute -bottom-4 -right-4 w-12 h-12 bg-red-600 blur-xl opacity-50"></div>
        </div>
      );
    };

    // --- MAIN APP ---
    const getDifficultyRank = (d) => {
        switch (d) {
            case Difficulty.NORMAL: return 0;
            case Difficulty.HARD: return 1;
            case Difficulty.HELL: return 2;
            default: return 0;
        }
    };

    const App = () => {
      const [phase, setPhase] = useState(GamePhase.DIFFICULTY_SELECT);
      const [maxUnlockedDifficulty, setMaxUnlockedDifficulty] = useState(() => {
          const saved = localStorage.getItem('aow_max_diff');
          if (saved === Difficulty.HARD || saved === Difficulty.HELL) return saved;
          return Difficulty.NORMAL;
      });
      const [difficulty, setDifficulty] = useState(Difficulty.NORMAL);
      const [level, setLevel] = useState(1);
      const [coins, setCoins] = useState(2000);
      const [recruitCost, setRecruitCost] = useState(RECRUIT_COST);
      const [unitCosts, setUnitCosts] = useState(() => {
        const costs = {};
        Object.values(UnitType).forEach(type => {
            const stats = UNIT_BASE_STATS[type];
            const tierMult = TIER_INFO[stats.tier].costMult;
            costs[type] = Math.floor(RECRUIT_COST * tierMult);
        });
        return costs;
      });
      const [gameStats, setGameStats] = useState({ kills: 0, merges: 0, wins: 0, summons: 0 });
      const [claimedAchievements, setClaimedAchievements] = useState(new Set());
      const [globalTech, setGlobalTech] = useState({ [GlobalTechType.CAPACITY]: 1, [GlobalTechType.LUCK]: 1, [GlobalTechType.MYTHIC_MASTERY]: 1 });
      const [techLevels, setTechLevels] = useState(() => {
        const initialTech = {};
        Object.values(UnitType).forEach(t => initialTech[t] = 1);
        return initialTech;
      });
      const [artifactLevels, setArtifactLevels] = useState({
        [ArtifactType.HOLY_SWORD]: 0, [ArtifactType.ANCIENT_SHIELD]: 0, [ArtifactType.WAR_DRUMS]: 0, [ArtifactType.WIND_CLOAK]: 0, [ArtifactType.MIDAS_TOUCH]: 0,
      });
      const [artifactCost, setArtifactCost] = useState(ARTIFACT_COST_BASE);

      const [isUpgradeModalOpen, setIsUpgradeModalOpen] = useState(false);
      const [isArtifactModalOpen, setIsArtifactModalOpen] = useState(false);
      const [isAltarModalOpen, setIsAltarModalOpen] = useState(false);
      const [isHelpModalOpen, setIsHelpModalOpen] = useState(false);
      const [isShopModalOpen, setIsShopModalOpen] = useState(false);
      const [isAchievementModalOpen, setIsAchievementModalOpen] = useState(false);
      const [resetConfirmation, setResetConfirmation] = useState(null); // 'MODE' | 'FULL' | null
      
      const [shopTab, setShopTab] = useState(UnitTier.COMMON);
      const [selectedUnit, setSelectedUnit] = useState(null);
      const [toast, setToast] = useState(null);
      const toastTimer = useRef(null);
      const [lastSupplyTime, setLastSupplyTime] = useState(Date.now());
      const [canClaimSupply, setCanClaimSupply] = useState(false);
      const [entities, setEntities] = useState([]);
      const entitiesRef = useRef([]);
      const [draggingId, setDraggingId] = useState(null);
      const [dragPos, setDragPos] = useState(null); 
      const [hoveredGrid, setHoveredGrid] = useState(null);
      
      const dragOffset = useRef({ x: 0, y: 0 });
      const dragStartPos = useRef({ x: 0, y: 0 });
      const gridRef = useRef(null);

      const [loadingLevel, setLoadingLevel] = useState(false);
      const [justUnlockedDifficulty, setJustUnlockedDifficulty] = useState(null);

      const maxUnitCap = BASE_UNIT_CAP + (globalTech[GlobalTechType.CAPACITY] - 1) * UNIT_CAP_PER_LEVEL;
      const hasClaimableAchievements = ACHIEVEMENTS.some(ach => {
          const current = gameStats[ach.type];
          return current >= ach.target && !claimedAchievements.has(ach.id);
      });

      const getPlayerTechLevel = useCallback((type) => {
          const stats = UNIT_BASE_STATS[type];
          if (stats.tier === UnitTier.MYTHIC) return globalTech[GlobalTechType.MYTHIC_MASTERY];
          return techLevels[type];
      }, [globalTech, techLevels]);

      const playSound = (type) => {};

      const showToast = (msg, subMsg, color, icon) => {
        if (toastTimer.current) window.clearTimeout(toastTimer.current);
        setToast({ msg, subMsg, color, icon });
        toastTimer.current = window.setTimeout(() => setToast(null), 2000);
      };

      useEffect(() => { localStorage.setItem('aow_max_diff', maxUnlockedDifficulty); }, [maxUnlockedDifficulty]);

      useEffect(() => {
        const interval = setInterval(() => {
            if (!canClaimSupply && Date.now() - lastSupplyTime > 30000 && phase !== GamePhase.DIFFICULTY_SELECT) setCanClaimSupply(true);
        }, 1000);
        return () => clearInterval(interval);
      }, [lastSupplyTime, canClaimSupply, phase]);

      const getGoldMultiplier = () => {
          const midasLvl = artifactLevels[ArtifactType.MIDAS_TOUCH] || 0;
          return 1 + (midasLvl * 0.10);
      };

      const claimSupply = () => {
          const baseAmount = 100 + (level * 10);
          const mult = getGoldMultiplier();
          const finalAmount = Math.floor(baseAmount * mult);
          setCoins(prev => prev + finalAmount);
          setLastSupplyTime(Date.now());
          setCanClaimSupply(false);
          playSound('coin');
          showToast("ë³´ê¸‰í’ˆ ë„ì°©!", `+${finalAmount} ì½”ì¸ (ìœ ë¬¼ +${Math.round((mult-1)*100)}%)`, "bg-blue-500", <Gift size={24}/>);
      };

      useEffect(() => {
        if (phase === GamePhase.PREPARATION) entitiesRef.current = entities;
      }, [entities, phase]);

      const loadLevel = async (lvl, diff) => {
        setLoadingLevel(true);
        setSelectedUnit(null);
        const playerUnits = entitiesRef.current.filter(e => e.side === Side.PLAYER).map(e => {
             const techLvl = getPlayerTechLevel(e.type);
             const stats = getUnitStats(e.type, e.level, techLvl, artifactLevels);
             return { ...e, x: e.gridX, y: e.gridY, hp: stats.hp, maxHp: stats.hp, targetId: null, state: 'IDLE', facingRight: true };
          });

        try {
          const config = await generateLevel(lvl, diff);
          const diffSetting = DIFFICULTY_SETTINGS[diff];
          const enemyTechLevel = Math.max(1, Math.ceil(lvl / 10 * diffSetting.enemyMult));
          const enemyUnits = config.enemies.map(e => createEntity(e.type, e.level, Side.ENEMY, e.gridX, e.gridY, enemyTechLevel, {}));
          const nextEntities = [...playerUnits, ...enemyUnits];
          setEntities(nextEntities);
          entitiesRef.current = nextEntities;
          setPhase(GamePhase.PREPARATION);
        } catch (e) {
          console.error(e);
        } finally {
          setLoadingLevel(false);
        }
      };

      const resetRunData = () => {
          cancelAnimationFrame(battleLoopId.current);
          setLevel(1);
          setCoins(2000);
          setRecruitCost(RECRUIT_COST);
          const initialCosts = {};
          Object.values(UnitType).forEach(type => {
              const stats = UNIT_BASE_STATS[type];
              const tierMult = TIER_INFO[stats.tier].costMult;
              initialCosts[type] = Math.floor(RECRUIT_COST * tierMult);
          });
          setUnitCosts(initialCosts);
          setGameStats({ kills: 0, merges: 0, wins: 0, summons: 0 });
          setGlobalTech({ [GlobalTechType.CAPACITY]: 1, [GlobalTechType.LUCK]: 1, [GlobalTechType.MYTHIC_MASTERY]: 1 });
          const initialTech = {};
          Object.values(UnitType).forEach(t => initialTech[t] = 1);
          setTechLevels(initialTech);
          setArtifactLevels({ [ArtifactType.HOLY_SWORD]: 0, [ArtifactType.ANCIENT_SHIELD]: 0, [ArtifactType.WAR_DRUMS]: 0, [ArtifactType.WIND_CLOAK]: 0, [ArtifactType.MIDAS_TOUCH]: 0 });
          setArtifactCost(ARTIFACT_COST_BASE);
          setEntities([]);
          entitiesRef.current = [];
      };

      const startGame = (diff) => {
          setDifficulty(diff);
          resetRunData();
          loadLevel(1, diff);
      };

      const nextLevel = () => {
        const diffSetting = DIFFICULTY_SETTINGS[difficulty];
        if (level >= diffSetting.maxLevel) {
            let unlockedNext = false;
            if (difficulty === Difficulty.NORMAL && getDifficultyRank(maxUnlockedDifficulty) < getDifficultyRank(Difficulty.HARD)) {
                setMaxUnlockedDifficulty(Difficulty.HARD);
                setJustUnlockedDifficulty('í•˜ë“œ');
                unlockedNext = true;
            } else if (difficulty === Difficulty.HARD && getDifficultyRank(maxUnlockedDifficulty) < getDifficultyRank(Difficulty.HELL)) {
                setMaxUnlockedDifficulty(Difficulty.HELL);
                setJustUnlockedDifficulty('ì§€ì˜¥');
                unlockedNext = true;
            } else {
                setJustUnlockedDifficulty(null);
            }
            setPhase(GamePhase.GAME_CLEAR);
        } else {
            setLevel(prev => prev + 1);
            loadLevel(level + 1, difficulty);
        }
      };

      const retryLevel = () => { loadLevel(level, difficulty); };

      // Replaced window.confirm with in-game UI via state
      const requestModeReset = () => setResetConfirmation('MODE');
      const requestFullReset = () => setResetConfirmation('FULL');

      const executeModeReset = () => {
        setResetConfirmation(null);
        cancelAnimationFrame(battleLoopId.current);
        resetRunData();
        setPhase(GamePhase.PREPARATION);
        setTimeout(() => loadLevel(1, difficulty), 0);
        setIsHelpModalOpen(false);
        showToast("ë‚œì´ë„ ì´ˆê¸°í™”", `${DIFFICULTY_SETTINGS[difficulty].name} ëª¨ë“œ ì¬ì‹œì‘`, "bg-orange-500", <RefreshCw size={24}/>);
      };

      const executeFullReset = () => {
        setResetConfirmation(null);
        cancelAnimationFrame(battleLoopId.current);
        localStorage.removeItem('aow_max_diff');
        setMaxUnlockedDifficulty(Difficulty.NORMAL);
        setClaimedAchievements(new Set()); 
        resetRunData(); 
        setPhase(GamePhase.DIFFICULTY_SELECT);
        setIsHelpModalOpen(false);
        showToast("ë°ì´í„° ì‚­ì œ ì™„ë£Œ", "ëª¨ë“  ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.", "bg-red-600", <Trash2 size={24}/>);
      };

      const handleSynthesize = (recipe) => {
        if (coins < recipe.cost) { showToast("ë¹„ìš© ë¶€ì¡±", "ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", "bg-gray-600", <Lock size={24}/>); return; }
        const playerEntities = entities.filter(e => e.side === Side.PLAYER);
        const ing1 = playerEntities.find(e => e.type === recipe.ingredients[0] && e.level >= recipe.minLevel);
        const ing2 = ing1 ? playerEntities.find(e => e.type === recipe.ingredients[1] && e.level >= recipe.minLevel && e.id !== ing1.id) : null;
        if (ing1 && ing2) {
            setCoins(c => c - recipe.cost);
            setEntities(prev => {
                const stillHasIng1 = prev.some(e => e.id === ing1.id);
                const stillHasIng2 = prev.some(e => e.id === ing2.id);
                if (!stillHasIng1 || !stillHasIng2) return prev; 
                const withoutIngredients = prev.filter(e => e.id !== ing1.id && e.id !== ing2.id);
                const newUnit = createEntity(recipe.result, 1, Side.PLAYER, ing1.gridX, ing1.gridY, getPlayerTechLevel(recipe.result), artifactLevels);
                return [...withoutIngredients, newUnit];
            });
            playSound('gacha');
            showToast("ì‹ í™” ìœ ë‹› ê°•ë¦¼!", `${UNIT_NAMES[recipe.result]} ì†Œí™˜ ì™„ë£Œ`, "bg-red-600", <span className="text-2xl">âš¡</span>);
            setIsAltarModalOpen(false);
        } else {
          showToast("ì¬ë£Œ ë¶€ì¡±", `${recipe.minLevel}ë ˆë²¨ ì´ìƒì˜ ì¬ë£Œê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.`, "bg-gray-600", <X size={24}/>);
        }
      };

      const applyTechUpgrade = (type) => {
        const lvl = techLevels[type];
        const cost = TECH_COST_BASE + (lvl - 1) * TECH_COST_INCREASE; 
        if (coins >= cost) {
            setCoins(c => c - cost);
            setTechLevels(prev => {
                const newLevel = prev[type] + 1;
                const newTechs = { ...prev, [type]: newLevel };
                setEntities(currentEntities => currentEntities.map(ent => {
                        if (ent.side === Side.PLAYER && ent.type === type) {
                             const newStats = getUnitStats(ent.type, ent.level, newLevel, artifactLevels);
                             return { ...ent, maxHp: newStats.hp, hp: newStats.hp };
                        }
                        return ent;
                    }));
                return newTechs;
            });
            playSound('coin');
        }
      };

      const applyGlobalUpgrade = (type) => {
          const info = GLOBAL_TECH_INFO[type];
          const lvl = globalTech[type];
          if (lvl >= info.maxLevel) return;
          const cost = info.baseCost + (lvl - 1) * info.costInc;
          if (coins >= cost) {
              setCoins(c => c - cost);
              setGlobalTech(prev => {
                  const newLvl = prev[type] + 1;
                  const newGlobalTech = { ...prev, [type]: newLvl };
                  if (type === GlobalTechType.MYTHIC_MASTERY) {
                      setEntities(currentEntities => currentEntities.map(ent => {
                            const stats = UNIT_BASE_STATS[ent.type];
                            if (ent.side === Side.PLAYER && stats.tier === UnitTier.MYTHIC) {
                                 const newStats = getUnitStats(ent.type, ent.level, newLvl, artifactLevels);
                                 return { ...ent, maxHp: newStats.hp, hp: newStats.hp };
                            }
                            return ent;
                        }));
                  }
                  return newGlobalTech;
              });
              playSound('coin');
              showToast("ì—°êµ¬ ì™„ë£Œ!", `${info.name} Lv.${lvl + 1}`, "bg-purple-600", <Activity size={24}/>);
          }
      };

      const handleBuyArtifact = () => {
          if (coins >= artifactCost) {
              setCoins(c => c - artifactCost);
              const types = Object.values(ArtifactType);
              const randomType = types[Math.floor(Math.random() * types.length)];
              setArtifactLevels(prev => {
                  const newLvl = (prev[randomType] || 0) + 1;
                  const newLevels = { ...prev, [randomType]: newLvl };
                  setEntities(currentEntities => currentEntities.map(ent => {
                        if (ent.side === Side.PLAYER) {
                             const techLvl = getPlayerTechLevel(ent.type);
                             const newStats = getUnitStats(ent.type, ent.level, techLvl, newLevels);
                             return { ...ent, maxHp: newStats.hp, hp: ent.hp + (newStats.hp - ent.maxHp) };
                        }
                        return ent;
                    }));
                  return newLevels;
              });
              setArtifactCost(prev => prev + ARTIFACT_COST_INCREASE);
              playSound('gacha');
              const info = ARTIFACT_INFO[randomType];
              showToast(`ìœ ë¬¼ íšë“!`, `${info.name} (Lv.${(artifactLevels[randomType] || 0) + 1})`, "bg-yellow-600", <span className="text-2xl">{info.icon}</span>);
          } else {
              showToast("ìê¸ˆ ë¶€ì¡±", "ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", "bg-gray-600", <Lock size={24}/>);
          }
      };
      
      const handleSellUnit = () => {
          if (!selectedUnit || selectedUnit.side !== Side.PLAYER) return;
          const stats = UNIT_BASE_STATS[selectedUnit.type];
          const tierInfo = TIER_INFO[stats.tier];
          const baseValue = Math.floor(recruitCost * tierInfo.costMult);
          const totalValue = baseValue * Math.pow(2, selectedUnit.level - 1);
          const refund = Math.floor(totalValue * 0.2); 
          setCoins(prev => prev + refund);
          setEntities(prev => prev.filter(e => e.id !== selectedUnit.id));
          playSound('coin');
          showToast("ìœ ë‹› íŒë§¤", `+${refund} ì½”ì¸`, "bg-yellow-600", <Coins size={24}/>);
          setSelectedUnit(null);
      };

      const claimAchievement = (achId, reward) => {
          if (claimedAchievements.has(achId)) return;
          setCoins(prev => prev + reward);
          setClaimedAchievements(prev => {
              const next = new Set(prev);
              next.add(achId);
              return next;
          });
          playSound('win');
          showToast("ì—…ì  ë‹¬ì„±!", `ë³´ìƒ: ${reward} ì½”ì¸`, "bg-green-600", <Medal size={24}/>);
      };

      const lastTimeRef = useRef(0);
      const battleLoopId = useRef(0);

      const battleTick = useCallback((timestamp) => {
        if (phase !== GamePhase.BATTLE) return;
        const dt = (timestamp - lastTimeRef.current) / 1000;
        lastTimeRef.current = timestamp;
        const safeDt = Math.min(dt, 0.1);
        const activeEntities = entitiesRef.current.map(e => ({ ...e }));
        let playerAlive = false, enemyAlive = false, somethingChanged = false, newKills = 0;

        activeEntities.forEach(e => {
          if (e.hp > 0) {
            if (e.side === Side.PLAYER) playerAlive = true;
            if (e.side === Side.ENEMY) enemyAlive = true;
          } else {
            if (e.state !== 'DEAD') {
              e.state = 'DEAD';
              if (e.side === Side.ENEMY) newKills++;
              somethingChanged = true;
            }
          }
        });

        if (newKills > 0) setGameStats(prev => ({ ...prev, kills: prev.kills + newKills }));

        if (playerAlive && enemyAlive) {
          activeEntities.forEach(entity => {
            if (entity.hp <= 0) return;
            const myTech = entity.side === Side.PLAYER ? getPlayerTechLevel(entity.type) : Math.max(1, Math.ceil(level / 5));
            const myArtifacts = entity.side === Side.PLAYER ? artifactLevels : {};
            const stats = getUnitStats(entity.type, entity.level, myTech, myArtifacts);
            const currentTarget = entity.targetId ? activeEntities.find(e => e.id === entity.targetId && e.hp > 0) : null;
            if (!currentTarget) {
              const newTarget = findNearestTarget(entity, activeEntities);
              if (newTarget) entity.targetId = newTarget.id;
              else { entity.state = 'IDLE'; return; }
            }
            const target = activeEntities.find(e => e.id === entity.targetId);
            if (target) {
                entity.facingRight = target.x > entity.x;
                const dist = getDistance(entity, target);
                if (dist <= stats.range) {
                    if (entity.state !== 'ATTACKING') { entity.state = 'ATTACKING'; somethingChanged = true; }
                    if (timestamp - entity.lastAttackTime > (1000 / stats.attackSpeed)) { target.hp -= stats.damage; entity.lastAttackTime = timestamp; somethingChanged = true; }
                } else {
                    if (entity.state !== 'MOVING') { entity.state = 'MOVING'; somethingChanged = true; }
                    const moveSpeed = stats.moveSpeed * safeDt;
                    const dx = target.x - entity.x;
                    const dy = target.y - entity.y;
                    const len = Math.sqrt(dx*dx + dy*dy);
                    if (len > 0) { entity.x += (dx / len) * moveSpeed; entity.y += (dy / len) * moveSpeed; }
                    activeEntities.forEach(other => {
                        if (entity.id !== other.id && other.hp > 0) {
                            const d = getDistance(entity, other);
                            if (d < 0.6) {
                                const pushX = entity.x - other.x;
                                const pushY = entity.y - other.y;
                                entity.x += pushX * 3 * safeDt;
                                entity.y += pushY * 3 * safeDt;
                            }
                        }
                    });
                    somethingChanged = true;
                }
            }
          });
        }
        entitiesRef.current = activeEntities;
        setEntities(activeEntities);

        if (!playerAlive && !enemyAlive) setPhase(GamePhase.DEFEAT);
        else if (!playerAlive) setPhase(GamePhase.DEFEAT);
        else if (!enemyAlive) {
           const baseLoot = 150 + (level * 50);
           const mult = getGoldMultiplier();
           setCoins(c => c + Math.floor(baseLoot * mult));
           setGameStats(prev => ({ ...prev, wins: prev.wins + 1 }));
           setPhase(GamePhase.VICTORY);
        } else {
           battleLoopId.current = requestAnimationFrame(battleTick);
        }
      }, [phase, level, getPlayerTechLevel, artifactLevels]); 

      useEffect(() => {
        if (phase === GamePhase.BATTLE) {
          lastTimeRef.current = performance.now();
          battleLoopId.current = requestAnimationFrame(battleTick);
        }
        return () => cancelAnimationFrame(battleLoopId.current);
      }, [phase, battleTick]);

      const handleBuyUnit = (buyType) => {
        const currentPlayerUnitCount = entities.filter(e => e.side === Side.PLAYER).length;
        if (currentPlayerUnitCount >= maxUnitCap) { showToast("ê³µê°„ ë¶€ì¡±", `ìµœëŒ€ ìœ ë‹› ìˆ˜(${maxUnitCap})ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤. ì—°êµ¬ì†Œì—ì„œ ë³‘ì˜ì„ í™•ì¥í•˜ì„¸ìš”.`, "bg-red-500", <Users size={24}/>); return; }
        let cost = 0;
        let finalType;
        if (buyType === 'RANDOM' || buyType === 'PREMIUM') cost = buyType === 'RANDOM' ? recruitCost : recruitCost * 2;
        else cost = unitCosts[buyType];

        if (coins >= cost) {
          const availableSpots = [];
          for(let y = GRID_ROWS - 1; y >= Math.floor(GRID_ROWS/2); y--) {
            for(let x = 0; x < GRID_COLS; x++) {
              if (!entities.find(e => e.gridX === x && e.gridY === y && e.hp > 0)) availableSpots.push({x, y});
            }
          }

          if (availableSpots.length > 0) {
            const spot = availableSpots[0];
            if (buyType === 'RANDOM') {
                const rand = Math.random();
                const types = Object.values(UnitType);
                const commons = types.filter(t => UNIT_BASE_STATS[t].tier === UnitTier.COMMON);
                const rares = types.filter(t => UNIT_BASE_STATS[t].tier === UnitTier.RARE);
                const epics = types.filter(t => UNIT_BASE_STATS[t].tier === UnitTier.EPIC);
                const legends = types.filter(t => UNIT_BASE_STATS[t].tier === UnitTier.LEGENDARY);
                const luckLvl = globalTech[GlobalTechType.LUCK] - 1;
                const legendProb = 0.01 + (luckLvl * 0.005);
                const epicProb = 0.09 + (luckLvl * 0.01);
                const rareProb = 0.30 + (luckLvl * 0.02);
                const legendThreshold = 1 - legendProb;
                const epicThreshold = legendThreshold - epicProb;
                const rareThreshold = epicThreshold - rareProb;
                if (rand > legendThreshold) finalType = legends[Math.floor(Math.random()*legends.length)];
                else if (rand > epicThreshold) finalType = epics[Math.floor(Math.random()*epics.length)];
                else if (rand > rareThreshold) finalType = rares[Math.floor(Math.random()*rares.length)];
                else finalType = commons[Math.floor(Math.random()*commons.length)];
            } else if (buyType === 'PREMIUM') {
                const luckLvl = globalTech[GlobalTechType.LUCK] - 1;
                const legendProb = 0.10 + (luckLvl * 0.01);
                const epicProb = 0.40 + (luckLvl * 0.02);
                const rand = Math.random();
                const types = Object.values(UnitType);
                const rares = types.filter(t => UNIT_BASE_STATS[t].tier === UnitTier.RARE);
                const epics = types.filter(t => UNIT_BASE_STATS[t].tier === UnitTier.EPIC);
                const legends = types.filter(t => UNIT_BASE_STATS[t].tier === UnitTier.LEGENDARY);
                if (rand > (1 - legendProb)) finalType = legends[Math.floor(Math.random()*legends.length)];
                else if (rand > (1 - legendProb - epicProb)) finalType = epics[Math.floor(Math.random()*epics.length)];
                else finalType = rares[Math.floor(Math.random()*rares.length)];
            } else {
                finalType = buyType;
            }

            const newUnit = createEntity(finalType, 1, Side.PLAYER, spot.x, spot.y, getPlayerTechLevel(finalType), artifactLevels);
            setCoins(prev => prev - cost);
            if (buyType === 'RANDOM' || buyType === 'PREMIUM') setRecruitCost(prev => prev + RECRUIT_COST_INCREASE);
            else setUnitCosts(prev => ({ ...prev, [buyType]: prev[buyType] + 10 }));

            setEntities(prev => [...prev, newUnit]);
            setGameStats(prev => ({ ...prev, summons: prev.summons + 1 }));
            playSound('pop');
            const stats = UNIT_BASE_STATS[finalType];
            const tierInfo = TIER_INFO[stats.tier];
            showToast(`${UNIT_NAMES[finalType]} íšë“!`, buyType === 'RANDOM' || buyType === 'PREMIUM' ? "ëœë¤ ì†Œí™˜ ì„±ê³µ" : "ì§€ì • í˜¸ì¶œ ì„±ê³µ", tierInfo.color.replace('text-', 'bg-').replace('400', '600'), <span className="text-2xl">{stats.icon}</span>);
          } else {
            showToast("ê³µê°„ ë¶€ì¡±", "ë°°ì¹˜í•  ê³µê°„ì´ ì—†ìŠµë‹ˆë‹¤.", "bg-red-500", <X size={24}/>);
          }
        } else {
            showToast("ìê¸ˆ ë¶€ì¡±", "ì½”ì¸ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.", "bg-gray-600", <Coins size={24}/>);
        }
      };

      const getGridFromClientPos = (clientX, clientY) => {
        const element = document.elementFromPoint(clientX, clientY);
        if (!element) return null;
        const target = element.closest('[data-grid-x]');
        if (!target) return null;
        const gridX = parseInt(target.getAttribute('data-grid-x') || '-1', 10);
        const gridY = parseInt(target.getAttribute('data-grid-y') || '-1', 10);
        if (gridX === -1 || gridY === -1) return null;
        return { gridX, gridY };
      };

      const handleMouseDown = (e, entity) => {
        if (phase !== GamePhase.PREPARATION) return;
        if (entity.side !== Side.PLAYER) { setSelectedUnit(entity); return; }
        e.preventDefault();
        startDrag(e.clientX, e.clientY, e.currentTarget, entity.id);
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      };
      const onMouseMove = (e) => moveDrag(e.clientX, e.clientY);
      const onMouseUp = (e) => {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        finishDrag(e.clientX, e.clientY);
      };
      const handleTouchStart = (e, entity) => {
        if (phase !== GamePhase.PREPARATION) return;
        if (entity.side !== Side.PLAYER) { setSelectedUnit(entity); return; }
        if(e.cancelable) e.preventDefault();
        const touch = e.touches[0];
        startDrag(touch.clientX, touch.clientY, e.currentTarget, entity.id);
        document.addEventListener('touchmove', onTouchMove, { passive: false });
        document.addEventListener('touchend', onTouchEnd);
      };
      const onTouchMove = (e) => {
        if(e.cancelable) e.preventDefault();
        const touch = e.touches[0];
        moveDrag(touch.clientX, touch.clientY);
      };
      const onTouchEnd = (e) => {
        document.removeEventListener('touchmove', onTouchMove);
        document.removeEventListener('touchend', onTouchEnd);
        const touch = e.changedTouches[0];
        finishDrag(touch.clientX, touch.clientY);
      };
      const startDrag = (clientX, clientY, element, entityId) => {
        const rect = element.getBoundingClientRect();
        const offsetX = clientX - rect.left;
        const offsetY = clientY - rect.top;
        dragOffset.current = { x: offsetX, y: offsetY };
        dragStartPos.current = { x: clientX, y: clientY }; 
        setDraggingId(entityId);
        setDragPos({ x: clientX - offsetX, y: clientY - offsetY });
      };
      const moveDrag = (clientX, clientY) => {
        setDragPos({ x: clientX - dragOffset.current.x, y: clientY - dragOffset.current.y });
        const gridPos = getGridFromClientPos(clientX, clientY);
        if (gridPos) setHoveredGrid(gridPos); else setHoveredGrid(null);
      };
      const draggingIdRef = useRef(null);
      useEffect(() => { draggingIdRef.current = draggingId; }, [draggingId]);
      const finishDrag = (clientX, clientY) => {
        const id = draggingIdRef.current;
        if (!id) return;
        const dist = Math.sqrt(Math.pow(clientX - dragStartPos.current.x, 2) + Math.pow(clientY - dragStartPos.current.y, 2));
        setDraggingId(null);
        setDragPos(null);
        setHoveredGrid(null);
        if (dist < 10) { 
            const clickedEntity = entities.find(e => e.id === id);
            if (clickedEntity) setSelectedUnit(clickedEntity);
            return;
        }
        const targetPos = getGridFromClientPos(clientX, clientY);
        if (!targetPos) return; 
        const { gridX, gridY } = targetPos;
        if (gridY < Math.floor(GRID_ROWS/2)) return; 
        setEntities(prev => {
            const meIndex = prev.findIndex(e => e.id === id);
            if (meIndex === -1) return prev;
            const me = prev[meIndex];
            const targetIndex = prev.findIndex(e => e.gridX === gridX && e.gridY === gridY && e.id !== id && e.hp > 0);
            if (targetIndex !== -1) {
                const target = prev[targetIndex];
                if (target.type === me.type && target.level === me.level) {
                    const newEntities = [...prev];
                    const techLvl = getPlayerTechLevel(target.type);
                    const newStats = getUnitStats(target.type, target.level + 1, techLvl, artifactLevels);
                    newEntities[targetIndex] = { ...target, level: target.level + 1, maxHp: newStats.hp, hp: newStats.hp };
                    newEntities.splice(meIndex, 1);
                    playSound('pop');
                    setGameStats(prev => ({ ...prev, merges: prev.merges + 1 }));
                    return newEntities;
                } else {
                    const newEntities = [...prev];
                    newEntities[meIndex] = { ...me, gridX: target.gridX, gridY: target.gridY, x: target.gridX, y: target.gridY };
                    newEntities[targetIndex] = { ...target, gridX: me.gridX, gridY: me.gridY, x: me.gridX, y: me.gridY };
                    return newEntities;
                }
            } else {
                const newEntities = [...prev];
                newEntities[meIndex] = { ...me, gridX, gridY, x: gridX, y: gridY };
                return newEntities;
            }
        });
      };

      const renderTiles = () => {
        const tiles = [];
        for(let y = 0; y < GRID_ROWS; y++) {
          for(let x = 0; x < GRID_COLS; x++) {
            const isEnemyTerritory = y < GRID_ROWS / 2;
            const isHovered = hoveredGrid?.x === x && hoveredGrid?.y === y;
            let highlightClass = '';
            if (isHovered && phase === GamePhase.PREPARATION) {
              highlightClass = isEnemyTerritory ? 'bg-red-500/50 shadow-[inset_0_0_20px_rgba(239,68,68,0.8)]' : 'bg-green-500/50 shadow-[inset_0_0_20px_rgba(34,197,94,0.8)]';
            }
            if (selectedUnit && phase === GamePhase.PREPARATION) {
                const tech = selectedUnit.side === Side.PLAYER ? getPlayerTechLevel(selectedUnit.type) : 1;
                const arts = selectedUnit.side === Side.PLAYER ? artifactLevels : {};
                const stats = getUnitStats(selectedUnit.type, selectedUnit.level, tech, arts);
                const dist = Math.sqrt(Math.pow(x - selectedUnit.gridX, 2) + Math.pow(y - selectedUnit.gridY, 2));
                if (dist <= stats.range) highlightClass = selectedUnit.side === Side.PLAYER ? 'bg-green-400/30 border-2 border-green-400/50' : 'bg-red-400/30 border-2 border-red-400/50';
            }
            tiles.push(<div key={`${x}-${y}`} data-grid-x={x} data-grid-y={y} className={`w-full h-full border border-white/5 transition-colors duration-150 ${isEnemyTerritory ? 'bg-red-900/10' : 'bg-blue-900/10'} ${!isEnemyTerritory && phase === GamePhase.PREPARATION && !draggingId ? 'hover:bg-blue-500/20' : ''} ${highlightClass}`}/>);
          }
        }
        return tiles;
      };

      if (phase === GamePhase.DIFFICULTY_SELECT) {
          return (
              <div className="w-full h-full flex flex-col items-center justify-center bg-gray-900 text-white p-4 relative overflow-hidden">
                  <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-50"></div>
                  <div className="z-10 text-center mb-10">
                      <div className="flex justify-center mb-4"><Swords size={64} className="text-yellow-500 animate-pulse" /></div>
                      <h1 className="font-display text-5xl md:text-6xl text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-yellow-600 mb-2 drop-shadow-lg">ART OF WAR</h1>
                      <p className="text-gray-400 text-lg">ì „ëµ í´ë¡ </p>
                  </div>
                  <div className="z-10 grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-4xl px-4">
                      {Object.values(Difficulty).map((diff) => {
                          const setting = DIFFICULTY_SETTINGS[diff];
                          const isUnlocked = getDifficultyRank(diff) <= getDifficultyRank(maxUnlockedDifficulty);
                          return (
                              <button key={diff} onClick={() => isUnlocked && startGame(diff)} disabled={!isUnlocked} className={`relative group border-2 rounded-2xl p-6 flex flex-col items-center justify-center gap-4 transition-all shadow-2xl overflow-hidden ${isUnlocked ? 'bg-slate-800 border-slate-600 hover:border-white hover:scale-105 active:scale-95 cursor-pointer' : 'bg-slate-900 border-slate-800 opacity-60 cursor-not-allowed grayscale'}`}>
                                  {!isUnlocked && (<div className="absolute inset-0 bg-black/50 z-20 flex items-center justify-center"><Lock size={40} className="text-gray-400" /></div>)}
                                  <div className={`text-4xl font-display ${setting.color} ${isUnlocked ? 'group-hover:scale-110 transition-transform' : ''}`}>{setting.name}</div>
                                  <div className="text-sm text-gray-400 text-center">{setting.desc}</div>
                                  <div className="absolute top-4 right-4 text-xs font-bold bg-black/40 px-2 py-1 rounded text-white">MAX LV.{setting.maxLevel}</div>
                                  {!isUnlocked && (<div className="text-xs text-red-400 font-bold mt-2">ì´ì „ ë‚œì´ë„ë¥¼ í´ë¦¬ì–´í•˜ì„¸ìš”</div>)}
                              </button>
                          );
                      })}
                  </div>
              </div>
          );
      }

      if (phase === GamePhase.GAME_CLEAR) {
          return (
              <div className="w-full h-full flex flex-col items-center justify-center bg-black/95 text-white p-4 z-50">
                    <Crown size={80} className="text-yellow-400 mb-6 animate-bounce" />
                    <h1 className="font-display text-5xl md:text-6xl text-yellow-500 mb-4 text-center">GAME CLEAR!</h1>
                    <p className="text-xl text-gray-300 mb-4 text-center max-w-md">ì¶•í•˜í•©ë‹ˆë‹¤! <span className={DIFFICULTY_SETTINGS[difficulty].color}>{DIFFICULTY_SETTINGS[difficulty].name}</span> ë‚œì´ë„ë¥¼ ì •ë³µí–ˆìŠµë‹ˆë‹¤.</p>
                    {justUnlockedDifficulty && (<div className="bg-slate-800 border border-yellow-500/50 p-4 rounded-xl mb-8 flex items-center gap-3 animate-pop"><Lock size={24} className="text-yellow-400" /><span className="text-yellow-100 font-bold text-lg"><span className="text-yellow-400">{justUnlockedDifficulty}</span> ë‚œì´ë„ê°€ í•´ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤!</span></div>)}
                    <div className="flex gap-4"><button onClick={() => setPhase(GamePhase.DIFFICULTY_SELECT)} className="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-xl border-2 border-slate-500 flex items-center gap-2"><RefreshCw size={20}/> ì²˜ìŒìœ¼ë¡œ</button></div>
              </div>
          );
      }

      return (
        <div className="w-full h-full flex flex-col items-center bg-gray-900 relative">
          {toast && (<div className="absolute top-24 left-1/2 transform -translate-x-1/2 z-[60] animate-pop pointer-events-none w-full max-w-xs px-4"><div className={`${toast.color} text-white px-6 py-4 rounded-2xl border-2 border-white/50 shadow-[0_10px_30px_rgba(0,0,0,0.5)] flex items-center gap-4 backdrop-blur-md`}><div className="bg-white/20 p-2 rounded-xl">{toast.icon}</div><div><div className="font-bold text-lg drop-shadow-md">{toast.msg}</div>{toast.subMsg && <div className="text-xs text-white/80">{toast.subMsg}</div>}</div></div></div>)}

          {isShopModalOpen && (
              <div className="absolute inset-0 z-50 bg-black/90 flex items-center justify-center p-4">
                  <div className="bg-slate-800 border-2 border-blue-500 rounded-2xl w-full max-w-3xl p-4 sm:p-6 shadow-2xl animate-pop overflow-hidden flex flex-col max-h-[95vh]">
                      <div className="flex justify-between items-center mb-4"><h2 className="text-2xl font-bold text-white flex items-center gap-2"><ShoppingCart className="text-blue-400" /> ë³´ê¸‰ì†Œ</h2><button onClick={() => setIsShopModalOpen(false)} className="bg-gray-700 hover:bg-gray-600 text-white p-2 rounded-full"><X size={24}/></button></div>
                      <div className="grid grid-cols-2 gap-4 mb-6 shrink-0">
                          <button onClick={() => handleBuyUnit('RANDOM')} className={`relative bg-gradient-to-br from-blue-900 to-slate-900 p-4 rounded-xl border-2 border-blue-500 flex flex-col items-center justify-between hover:scale-[1.02] active:scale-95 transition-all ${coins < recruitCost ? 'opacity-50 grayscale' : ''}`} disabled={coins < recruitCost}>
                              <div className="absolute top-2 right-2 text-blue-300 text-xs border border-blue-500 px-2 rounded-full">ì¼ë°˜~ì˜ì›…</div><Package className="text-blue-400 mb-2 animate-bounce" size={40} /><div className="text-white font-bold text-lg">ì¼ë°˜ ë³´ê¸‰</div><div className="text-xs text-blue-200 mb-2">ì¼ë°˜ 60% / í¬ê·€ 30% / ì˜ì›… 9%</div><div className="bg-blue-600 px-4 py-1 rounded-full font-bold text-white flex items-center gap-1"><Coins size={14} className="text-yellow-300"/> {recruitCost}</div>
                          </button>
                          <button onClick={() => handleBuyUnit('PREMIUM')} className={`relative bg-gradient-to-br from-purple-900 to-slate-900 p-4 rounded-xl border-2 border-purple-500 flex flex-col items-center justify-between hover:scale-[1.02] active:scale-95 transition-all ${coins < recruitCost * 2 ? 'opacity-50 grayscale' : ''}`} disabled={coins < recruitCost * 2}>
                              <div className="absolute top-2 right-2 text-purple-300 text-xs border border-purple-500 px-2 rounded-full flex gap-1 items-center"><Crown size={10}/> í¬ê·€~ì „ì„¤</div><div className="relative"><Sparkles className="absolute -top-2 -right-4 text-yellow-300 animate-pulse" size={20} /><Gem className="text-purple-400 mb-2 animate-pulse" size={40} /></div><div className="text-white font-bold text-lg">í”„ë¦¬ë¯¸ì—„ ë³´ê¸‰</div><div className="text-xs text-purple-200 mb-2">í¬ê·€ 50% / ì˜ì›… 40% / ì „ì„¤ 10%</div><div className="bg-purple-600 px-4 py-1 rounded-full font-bold text-white flex items-center gap-1"><Coins size={14} className="text-yellow-300"/> {recruitCost * 2}</div>
                          </button>
                      </div>
                      <div className="flex gap-2 mb-4 overflow-x-auto pb-2 shrink-0">
                          {Object.values(UnitTier).map(tier => {
                              const info = TIER_INFO[tier];
                              const isActive = shopTab === tier;
                              if (tier === UnitTier.MYTHIC) return null;
                              return (<button key={tier} onClick={() => setShopTab(tier)} className={`px-4 py-2 rounded-lg font-bold whitespace-nowrap transition-all flex-1 ${isActive ? 'bg-slate-200 text-slate-900' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}><span className={info.color}>{info.name}</span></button>)
                          })}
                      </div>
                      <div className="overflow-y-auto pr-2 grid grid-cols-2 sm:grid-cols-3 gap-3 pb-4">
                          {Object.values(UnitType).filter(type => UNIT_BASE_STATS[type].tier === shopTab).map(type => {
                              const stats = UNIT_BASE_STATS[type];
                              const tierInfo = TIER_INFO[stats.tier];
                              const cost = unitCosts[type];
                              return (
                                <button key={type} onClick={() => handleBuyUnit(type)} className={`relative bg-slate-700 p-3 rounded-xl border-2 flex flex-col items-center gap-2 transition-all active:scale-95 ${tierInfo.borderColor} ${coins < cost ? 'opacity-50 grayscale cursor-not-allowed' : 'hover:bg-slate-600'}`} disabled={coins < cost}>
                                    <div className={`w-12 h-12 rounded-lg ${stats.color} flex items-center justify-center text-2xl shadow-lg border-2 border-white/20`}>{stats.icon}</div><div className="font-bold text-white text-sm">{UNIT_NAMES[type]}</div><div className="text-yellow-400 font-bold text-xs flex items-center gap-1 bg-slate-800 px-3 py-1 rounded-full border border-yellow-500/30"><Coins size={10}/> {cost}</div>
                                </button>
                              );
                          })}
                      </div>
                  </div>
              </div>
          )}

          {isArtifactModalOpen && (
              <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                  <div className="bg-slate-800 border-4 border-yellow-500 rounded-2xl w-full max-w-lg p-6 shadow-2xl animate-pop overflow-y-auto max-h-[90vh]">
                      <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-white flex items-center gap-2"><Gem className="text-yellow-400" /> ê³ ëŒ€ ìœ ë¬¼ì†Œ</h2><button onClick={() => setIsArtifactModalOpen(false)} className="bg-gray-600 hover:bg-gray-500 text-white p-1 rounded-lg"><X size={20}/></button></div>
                      <div className="mb-6 bg-slate-900/50 p-4 rounded-xl border border-yellow-500/30 flex flex-col items-center gap-4">
                          <div className="text-center"><div className="text-yellow-200 mb-1">ì‹ ë¹„ë¡œìš´ ìœ ë¬¼ ìƒì</div><div className="text-xs text-gray-400">ëœë¤í•œ ìœ ë¬¼ì„ íšë“í•˜ê±°ë‚˜ ê°•í™”í•©ë‹ˆë‹¤.</div></div>
                          <button onClick={handleBuyArtifact} disabled={coins < artifactCost} className={`w-full py-4 rounded-xl font-bold text-xl shadow-lg border-2 border-yellow-400 flex flex-col items-center gap-1 transition-all active:scale-95 ${coins >= artifactCost ? 'bg-gradient-to-r from-yellow-600 to-orange-600 text-white hover:brightness-110' : 'bg-gray-700 text-gray-500 cursor-not-allowed border-gray-600'}`}><span className="flex items-center gap-2">ğŸ’ ìœ ë¬¼ ì†Œí™˜</span><span className="text-sm flex items-center gap-1 bg-black/30 px-3 py-1 rounded-full"><Coins size={14} className="text-yellow-400"/> {artifactCost}</span></button>
                      </div>
                      <div className="space-y-3">
                          <div className="text-sm text-gray-400 font-bold px-2">ë³´ìœ  ìœ ë¬¼</div>
                          {Object.values(ArtifactType).map(type => {
                              const info = ARTIFACT_INFO[type];
                              const lvl = artifactLevels[type] || 0;
                              return (<div key={type} className={`bg-slate-700 p-3 rounded-lg border flex items-center gap-4 ${lvl > 0 ? 'border-yellow-500/50 bg-slate-700' : 'border-slate-600 bg-slate-800 opacity-60'}`}><div className="text-3xl bg-slate-900 w-12 h-12 flex items-center justify-center rounded-lg border border-slate-600">{info.icon}</div><div className="flex-1"><div className="flex justify-between items-center"><div className={`font-bold ${lvl > 0 ? 'text-white' : 'text-gray-500'}`}>{info.name}</div>{lvl > 0 && <div className="text-yellow-400 font-bold text-sm">Lv.{lvl}</div>}</div><div className="text-xs text-gray-400">{info.desc}</div></div><div className="text-right min-w-[50px]"><div className="text-green-400 font-bold text-sm">{lvl > 0 ? `+${(parseFloat(info.perLevel) * lvl)}%` : '-'}</div></div></div>)
                          })}
                      </div>
                  </div>
              </div>
          )}
          
          {isAltarModalOpen && (
              <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                  <div className="bg-slate-900 border-4 border-red-600 rounded-2xl w-full max-w-lg p-6 shadow-2xl animate-pop overflow-y-auto max-h-[90vh] relative">
                      <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-red-100 flex items-center gap-2"><Flame className="text-red-500 animate-pulse" /> ê¸ˆì§€ëœ ì œë‹¨</h2><button onClick={() => setIsAltarModalOpen(false)} className="bg-red-900 hover:bg-red-800 text-white p-1 rounded-lg"><X size={20}/></button></div>
                      <div className="text-sm text-gray-400 mb-4 text-center">ê°•ë ¥í•œ ìœ ë‹›ì„ í¬ìƒí•˜ì—¬ <span className="text-red-400 font-bold">ì‹ í™” ë“±ê¸‰</span> ìœ ë‹›ì„ ì†Œí™˜í•©ë‹ˆë‹¤.</div>
                      <div className="space-y-4">
                          {SYNTHESIS_RECIPES.map(recipe => {
                              const resultStats = UNIT_BASE_STATS[recipe.result];
                              const hasIng1 = entities.some(e => e.type === recipe.ingredients[0] && e.level >= recipe.minLevel && e.side === Side.PLAYER);
                              const hasIng2 = recipe.ingredients[0] === recipe.ingredients[1] ? entities.filter(e => e.type === recipe.ingredients[0] && e.level >= recipe.minLevel && e.side === Side.PLAYER).length >= 2 : entities.some(e => e.type === recipe.ingredients[1] && e.level >= recipe.minLevel && e.side === Side.PLAYER);
                              const canCraft = hasIng1 && hasIng2 && coins >= recipe.cost;
                              return (
                                  <div key={recipe.id} className="bg-slate-800 p-4 rounded-xl border border-red-900 relative overflow-hidden group">
                                      <div className="absolute inset-0 bg-gradient-to-r from-black via-red-900/10 to-black opacity-50"></div>
                                      <div className="relative z-10 flex flex-col gap-3">
                                          <div className="flex items-center justify-between">
                                              <div className="flex items-center gap-3"><div className="w-12 h-12 bg-red-900 rounded-lg flex items-center justify-center border-2 border-red-500 shadow-[0_0_15px_rgba(239,68,68,0.5)]"><span className="text-3xl">{resultStats.icon}</span></div><div><div className="font-bold text-red-200 text-lg">{UNIT_NAMES[recipe.result]}</div><div className="text-xs text-red-400">ì‹ í™” ë“±ê¸‰ ìœ ë‹›</div></div></div>
                                              <button onClick={() => handleSynthesize(recipe)} disabled={!canCraft} className={`px-4 py-2 rounded-lg font-bold shadow-lg transition-all flex flex-col items-center ${canCraft ? 'bg-red-600 hover:bg-red-500 text-white animate-pulse' : 'bg-slate-700 text-gray-500 cursor-not-allowed'}`}><span>ì†Œí™˜</span><span className="text-xs flex items-center gap-1 opacity-80"><Coins size={10}/> {recipe.cost}</span></button>
                                          </div>
                                          <div className="flex items-center justify-center gap-2 bg-black/40 p-2 rounded-lg">
                                              <div className={`flex items-center gap-1 ${hasIng1 ? 'text-green-400' : 'text-gray-500'}`}><span>{UNIT_BASE_STATS[recipe.ingredients[0]].icon}</span><span className="text-xs">{UNIT_NAMES[recipe.ingredients[0]]} Lv.{recipe.minLevel}+</span></div>
                                              <span className="text-gray-600">+</span>
                                              <div className={`flex items-center gap-1 ${hasIng2 ? 'text-green-400' : 'text-gray-500'}`}><span>{UNIT_BASE_STATS[recipe.ingredients[1]].icon}</span><span className="text-xs">{UNIT_NAMES[recipe.ingredients[1]]} Lv.{recipe.minLevel}+</span></div>
                                          </div>
                                      </div>
                                  </div>
                              );
                          })}
                      </div>
                  </div>
              </div>
          )}

          {isAchievementModalOpen && (
              <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                  <div className="bg-slate-800 border-4 border-green-500 rounded-2xl w-full max-w-lg p-6 shadow-2xl animate-pop overflow-y-auto max-h-[90vh]">
                      <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-white flex items-center gap-2"><Medal className="text-green-400" /> ì—…ì </h2><button onClick={() => setIsAchievementModalOpen(false)} className="bg-gray-600 hover:bg-gray-500 text-white p-1 rounded-lg"><X size={20}/></button></div>
                      <div className="space-y-4">
                          {ACHIEVEMENTS.map(ach => {
                              const current = gameStats[ach.type];
                              const progress = Math.min(100, (current / ach.target) * 100);
                              const isCompleted = current >= ach.target;
                              const isClaimed = claimedAchievements.has(ach.id);
                              return (
                                  <div key={ach.id} className={`p-4 rounded-xl border-2 flex items-center gap-4 transition-all ${isCompleted ? 'bg-green-900/30 border-green-500' : 'bg-slate-700 border-slate-600'}`}>
                                      <div className={`text-3xl w-12 h-12 flex items-center justify-center rounded-full border-2 ${isCompleted ? 'bg-green-600 border-green-400' : 'bg-slate-800 border-slate-600 grayscale'}`}>{ach.icon}</div>
                                      <div className="flex-1">
                                          <div className="flex justify-between items-center mb-1"><div className={`font-bold ${isCompleted ? 'text-green-400' : 'text-gray-300'}`}>{ach.title}</div>{isCompleted && !isClaimed ? (<div className="text-green-400 font-bold text-xs animate-pulse">ë³´ìƒ ìˆ˜ë ¹ ê°€ëŠ¥!</div>) : (<div className="text-xs font-mono text-gray-400">{current} / {ach.target}</div>)}</div>
                                          <div className="text-xs text-gray-400 mb-2">{ach.desc}</div>
                                          {isCompleted && !isClaimed ? (<button onClick={() => claimAchievement(ach.id, ach.reward)} className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2 animate-bounce shadow-lg"><span>ë³´ìƒ ë°›ê¸°</span><span className="bg-black/20 px-2 rounded-full text-sm flex items-center gap-1"><Coins size={12} className="text-yellow-300"/> {ach.reward}</span></button>) : isClaimed ? (<div className="w-full bg-slate-800 text-gray-500 font-bold py-1.5 rounded-lg flex items-center justify-center gap-2 border border-slate-600"><CheckCircle2 size={16} /> ë‹¬ì„± ì™„ë£Œ</div>) : (<><div className="w-full h-2 bg-slate-900 rounded-full overflow-hidden mb-1"><div className={`h-full transition-all duration-500 ${isCompleted ? 'bg-green-500' : 'bg-blue-500'}`} style={{ width: `${progress}%` }}></div></div><div className="text-[10px] text-right text-yellow-500 flex justify-end items-center gap-1">ë³´ìƒ: <Coins size={10}/> {ach.reward}</div></>)}
                                      </div>
                                  </div>
                              );
                          })}
                      </div>
                  </div>
              </div>
          )}

          {isUpgradeModalOpen && (
            <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                <div className="bg-slate-800 border-4 border-purple-500 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-pop overflow-y-auto max-h-[90vh]">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-white flex items-center gap-2"><Activity className="text-purple-400" /> ì—°êµ¬ì†Œ</h2><button onClick={() => setIsUpgradeModalOpen(false)} className="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg">X</button></div>
                    <div className="space-y-4">
                        <div className="space-y-3 mb-6">
                            <div className="text-sm font-bold text-gray-400 uppercase tracking-widest px-2">ê¸°ë°˜ ì‹œì„¤</div>
                            {Object.values(GlobalTechType).map(type => {
                                const info = GLOBAL_TECH_INFO[type];
                                const lvl = globalTech[type];
                                const cost = info.baseCost + (lvl - 1) * info.costInc;
                                const isMax = lvl >= info.maxLevel;
                                const canAfford = coins >= cost && !isMax;
                                return (
                                    <div key={type} className="bg-slate-700 p-4 rounded-xl flex flex-col gap-3 border-2 border-slate-600 relative overflow-hidden">
                                        <div className="flex items-center justify-between z-10">
                                            <div className="flex items-center gap-4">
                                                <div className={`w-12 h-12 rounded-lg ${type === GlobalTechType.CAPACITY ? 'bg-blue-900' : type === GlobalTechType.LUCK ? 'bg-purple-900' : 'bg-red-900'} flex items-center justify-center text-2xl shadow-lg border-2 border-white/20`}>
                                                    {type === GlobalTechType.CAPACITY && <Users className="text-blue-300"/>}{type === GlobalTechType.LUCK && <Clover className="text-purple-300"/>}{type === GlobalTechType.MYTHIC_MASTERY && <Flame className="text-red-300"/>}
                                                </div>
                                                <div><div className="font-bold text-white text-lg">{info.name} <span className="text-yellow-400">Lv.{lvl}</span></div><div className="text-xs text-gray-400">{info.desc}</div><div className="text-xs text-green-400 font-bold mt-1">{type === GlobalTechType.CAPACITY && `ìµœëŒ€ ì¸êµ¬: ${BASE_UNIT_CAP + (lvl-1)*2} â†’ ${BASE_UNIT_CAP + lvl*2}`}{type === GlobalTechType.LUCK && `í™•ë¥  ë³´ë„ˆìŠ¤: +${(lvl-1)*0.5}% â†’ +${lvl*0.5}%`}{type === GlobalTechType.MYTHIC_MASTERY && `ì‹ í™” ìœ ë‹› ëŠ¥ë ¥ì¹˜: +${(lvl-1)*20}% â†’ +${lvl*20}%`}</div></div>
                                            </div>
                                            <button onClick={() => applyGlobalUpgrade(type)} disabled={!canAfford} className={`flex flex-col items-center justify-center px-4 py-2 rounded-lg font-bold min-w-[80px] ${isMax ? 'bg-gray-800 text-gray-500' : canAfford ? 'bg-purple-600 hover:bg-purple-500 text-white shadow-[0_4px_0_rgb(147,51,234)] active:shadow-none active:translate-y-1' : 'bg-gray-600 text-gray-400 cursor-not-allowed'} transition-all`}>{isMax ? (<div className="text-sm">MAX</div>) : (<><div className="text-sm">ê°•í™”</div><div className="text-xs flex items-center gap-1"><Coins size={10} /> {cost}</div></>)}</button>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="w-full h-[2px] bg-slate-600/50 my-4"></div>
                        <div className="space-y-3">
                        <div className="text-sm font-bold text-gray-400 uppercase tracking-widest px-2">ìœ ë‹› ê°•í™”</div>
                        {Object.values(UnitType).filter(type => UNIT_BASE_STATS[type].tier !== UnitTier.MYTHIC).map(type => {
                            const lvl = techLevels[type];
                            const cost = TECH_COST_BASE + (lvl - 1) * TECH_COST_INCREASE;
                            const canAfford = coins >= cost;
                            const currentStats = getUnitStats(type, 1, lvl, artifactLevels);
                            const nextStats = getUnitStats(type, 1, lvl + 1, artifactLevels);
                            return (
                                <div key={type} className="bg-slate-700 p-4 rounded-xl flex flex-col gap-3 border-2 border-slate-600">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-4"><div className={`w-12 h-12 rounded-lg ${UNIT_BASE_STATS[type].color} flex items-center justify-center text-2xl shadow-lg border-2 border-black/30`}>{UNIT_BASE_STATS[type].icon}</div><div><div className="font-bold text-white text-lg">{UNIT_NAMES[type]} <span className="text-yellow-400">Lv.{lvl}</span></div><div className="text-xs text-gray-400">{TIER_INFO[UNIT_BASE_STATS[type].tier].name}</div></div></div>
                                        <button onClick={() => applyTechUpgrade(type)} disabled={!canAfford} className={`flex flex-col items-center justify-center px-4 py-2 rounded-lg font-bold min-w-[80px] ${canAfford ? 'bg-green-600 hover:bg-green-500 text-white shadow-[0_4px_0_rgb(21,128,61)] active:shadow-none active:translate-y-1' : 'bg-gray-600 text-gray-400 cursor-not-allowed'} transition-all`}><div className="text-sm">ê°•í™”</div><div className="text-xs flex items-center gap-1"><Coins size={10} /> {cost}</div></button>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2 bg-slate-900/40 p-2 rounded-lg text-xs">
                                        <div className="flex justify-between items-center px-2"><span className="text-gray-400 flex items-center gap-1"><Heart size={10}/> HP</span><div className="flex gap-1"><span>{currentStats.hp}</span><span className="text-gray-500">â†’</span><span className="text-green-400 font-bold">{nextStats.hp}</span></div></div>
                                        <div className="flex justify-between items-center px-2"><span className="text-gray-400 flex items-center gap-1"><Swords size={10}/> DMG</span><div className="flex gap-1"><span>{currentStats.damage}</span><span className="text-gray-500">â†’</span><span className="text-green-400 font-bold">{nextStats.damage}</span></div></div>
                                    </div>
                                </div>
                            )
                        })}
                        </div>
                    </div>
                </div>
            </div>
          )}

          {isHelpModalOpen && (
              <div className="absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4">
                  <div className="bg-slate-800 border-4 border-gray-500 rounded-2xl w-full max-w-md p-6 shadow-2xl animate-pop">
                      <div className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold text-white flex items-center gap-2"><HelpCircle className="text-gray-400" /> ê²Œì„ ë„ì›€ë§</h2><button onClick={() => setIsHelpModalOpen(false)} className="bg-gray-600 hover:bg-gray-500 text-white p-1 rounded-lg"><X size={20}/></button></div>

                      {resetConfirmation ? (
                          <div className="text-center space-y-4 animate-pop">
                              <AlertTriangle className="mx-auto text-red-500 w-16 h-16 animate-bounce" />
                              <h3 className="text-xl font-bold text-white">{resetConfirmation === 'MODE' ? 'í˜„ì¬ ë‚œì´ë„ ì´ˆê¸°í™”' : 'ì „ì²´ ë°ì´í„° ì‚­ì œ'}</h3>
                              <div className="text-gray-300 text-sm whitespace-pre-line">
                                  {resetConfirmation === 'MODE' 
                                    ? `${DIFFICULTY_SETTINGS[difficulty].name} ë‚œì´ë„ë¥¼ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në³´ìœ  ì½”ì¸ ë° ì„±ì¥ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.` 
                                    : 'ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ê¸ˆëœ ë‚œì´ë„ì™€ ì—…ì  ì •ë³´ê°€ ëª¨ë‘ ì‚¬ë¼ì§€ë©° íƒ€ì´í‹€ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.'}
                              </div>
                              <div className="flex gap-4 pt-4">
                                  <button onClick={() => setResetConfirmation(null)} className="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-xl font-bold transition-colors">ì·¨ì†Œ</button>
                                  <button onClick={resetConfirmation === 'MODE' ? executeModeReset : executeFullReset} className="flex-1 bg-red-600 hover:bg-red-500 py-3 rounded-xl font-bold text-white transition-colors">í™•ì¸</button>
                              </div>
                          </div>
                      ) : (
                          <>
                              <div className="space-y-4 text-sm text-gray-300 mb-8">
                                  <p>â€¢ <span className="text-white font-bold">ìœ ë‹› ì†Œí™˜:</span> ë³´ê¸‰ì†Œì—ì„œ ìœ ë‹›ì„ ëª¨ì§‘í•˜ì„¸ìš”.</p>
                                  <p>â€¢ <span className="text-white font-bold">í•©ì„± (Merge):</span> ê°™ì€ ì¢…ë¥˜, ê°™ì€ ë ˆë²¨ì˜ ìœ ë‹›ì„ ë“œë˜ê·¸í•˜ì—¬ ê²¹ì¹˜ë©´ ë” ê°•ë ¥í•œ ìœ ë‹›ìœ¼ë¡œ ì§„í™”í•©ë‹ˆë‹¤.</p>
                                  <p>â€¢ <span className="text-white font-bold">ì œë‹¨ (Altar):</span> 3ë ˆë²¨ ì´ìƒì˜ ìœ ë‹›ì„ í¬ìƒí•˜ì—¬ ì‹ í™” ë“±ê¸‰ ìœ ë‹›ì„ ì†Œí™˜í•©ë‹ˆë‹¤.</p>
                                  <p>â€¢ <span className="text-white font-bold">ì „íˆ¬:</span> ì¤€ë¹„ ë‹¨ê³„ì—ì„œ ìœ ë‹›ì„ ë°°ì¹˜í•˜ê³  ì „íˆ¬ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                                  <p>â€¢ <span className="text-white font-bold">ì—°êµ¬ & ìœ ë¬¼:</span> ì½”ì¸ì„ ëª¨ì•„ ë¶€ëŒ€ë¥¼ ê°•í™”í•˜ì„¸ìš”.</p>
                              </div>
                              <div className="border-t border-gray-600 pt-6 grid grid-cols-2 gap-4">
                                  <button onClick={requestModeReset} className="w-full bg-orange-900/50 hover:bg-orange-800 border-2 border-orange-500 text-orange-200 py-3 rounded-xl flex flex-col items-center justify-center gap-1 transition-all active:scale-95"><RefreshCw size={20} /><span className="font-bold text-xs">í˜„ì¬ ë‚œì´ë„ ì´ˆê¸°í™”</span></button>
                                  <button onClick={requestFullReset} className="w-full bg-red-900/50 hover:bg-red-800 border-2 border-red-500 text-red-200 py-3 rounded-xl flex flex-col items-center justify-center gap-1 transition-all active:scale-95"><Trash2 size={20} /><span className="font-bold text-xs">ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”</span></button>
                                  <div className="col-span-2 text-center text-[10px] text-gray-500">'í˜„ì¬ ë‚œì´ë„ ì´ˆê¸°í™”'ëŠ” í˜„ì¬ ëª¨ë“œì˜ ì§„í–‰ ìƒí™©ë§Œ ì‚­ì œí•©ë‹ˆë‹¤.<br/>'ì „ì²´ ë°ì´í„° ì´ˆê¸°í™”'ëŠ” ëª¨ë“  í•´ê¸ˆ ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ì‚­ì œí•©ë‹ˆë‹¤.</div>
                              </div>
                          </>
                      )}
                  </div>
              </div>
          )}

          {selectedUnit && (
            <div onClick={(e) => { if(e.target === e.currentTarget) setSelectedUnit(null); }} className="absolute inset-0 z-50 bg-black/0 flex items-center justify-center p-4 pointer-events-auto">
                 <div className="bg-slate-800/95 backdrop-blur-md border-4 border-white rounded-2xl w-full max-w-sm p-6 shadow-2xl animate-pop relative overflow-hidden pointer-events-auto">
                    <div className={`absolute top-0 left-0 w-full h-2 ${selectedUnit.side === Side.PLAYER ? 'bg-blue-500' : 'bg-red-500'}`}></div>
                    <div className="flex justify-between items-start mb-6 mt-2"><div className="flex items-center gap-4"><div className={`w-16 h-16 rounded-xl ${UNIT_BASE_STATS[selectedUnit.type].color} flex items-center justify-center text-4xl shadow-lg border-2 border-white/20`}>{UNIT_BASE_STATS[selectedUnit.type].icon}</div><div><h2 className="text-2xl font-bold text-white uppercase tracking-wider">{UNIT_NAMES[selectedUnit.type]}</h2><div className="flex items-center gap-1"><span className={`font-bold text-sm px-2 py-0.5 rounded ${TIER_INFO[UNIT_BASE_STATS[selectedUnit.type].tier].color.replace('text-', 'bg-').replace('400', '900')} border border-white/20`}>{TIER_INFO[UNIT_BASE_STATS[selectedUnit.type].tier].name}</span><span className="text-yellow-400 font-bold text-lg">Lv.{selectedUnit.level}</span></div></div></div><button onClick={() => setSelectedUnit(null)} className="bg-slate-700 hover:bg-slate-600 text-white p-2 rounded-full transition-colors"><X size={20}/></button></div>
                    <div className="grid grid-cols-2 gap-4">
                         {(() => {
                             const tech = selectedUnit.side === Side.PLAYER ? getPlayerTechLevel(selectedUnit.type) : 1; 
                             const arts = selectedUnit.side === Side.PLAYER ? artifactLevels : {};
                             const stats = getUnitStats(selectedUnit.type, selectedUnit.level, tech, arts);
                             return (<><div className="bg-slate-700/50 p-3 rounded-xl flex flex-col items-center"><Heart className="text-red-400 mb-1" size={24} /><span className="text-xs text-gray-400">ì²´ë ¥ (HP)</span><span className="text-xl font-bold text-white">{stats.hp}</span></div><div className="bg-slate-700/50 p-3 rounded-xl flex flex-col items-center"><Swords className="text-blue-400 mb-1" size={24} /><span className="text-xs text-gray-400">ê³µê²©ë ¥ (DMG)</span><span className="text-xl font-bold text-white">{stats.damage}</span></div><div className="bg-slate-700/50 p-3 rounded-xl flex flex-col items-center"><Zap className="text-yellow-400 mb-1" size={24} /><span className="text-xs text-gray-400">ê³µê²© ì†ë„</span><span className="text-xl font-bold text-white">{stats.attackSpeed}<span className="text-xs">/s</span></span></div><div className="bg-slate-700/50 p-3 rounded-xl flex flex-col items-center"><div className="flex gap-2 w-full justify-center"><div className="flex flex-col items-center"><Target className="text-green-400 mb-1" size={20} /><span className="text-xs text-gray-400">ì‚¬ê±°ë¦¬</span><span className="font-bold">{stats.range}</span></div><div className="w-[1px] bg-white/10"></div><div className="flex flex-col items-center"><Move className="text-purple-400 mb-1" size={20} /><span className="text-xs text-gray-400">ì´ë™</span><span className="font-bold">{stats.moveSpeed}</span></div></div></div></>);
                         })()}
                    </div>
                    {selectedUnit.side === Side.PLAYER && phase === GamePhase.PREPARATION && (<div className="mt-6 flex justify-center"><button onClick={handleSellUnit} className="w-full bg-red-900/80 hover:bg-red-800 border-2 border-red-500/50 text-red-200 py-3 rounded-xl flex items-center justify-center gap-2 transition-all active:scale-95"><Trash2 size={20} /><span className="font-bold">íŒë§¤í•˜ê¸°</span><span className="text-xs bg-black/30 px-2 py-0.5 rounded-full flex items-center gap-1"><Coins size={10} className="text-yellow-400" />{Math.floor(Math.floor(recruitCost * TIER_INFO[UNIT_BASE_STATS[selectedUnit.type].tier].costMult) * Math.pow(2, selectedUnit.level - 1) * 0.2)}</span></button></div>)}
                    <div className="mt-4 text-center text-xs text-blue-300 animate-pulse">ë°”ë‹¥ì— í‘œì‹œëœ ì˜ì—­ì´ ê³µê²© ë²”ìœ„ì…ë‹ˆë‹¤.</div>
                 </div>
            </div>
          )}

          <div className="absolute top-0 w-full z-20 p-4 flex justify-between items-start bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
            <div className="flex flex-col gap-2 pointer-events-auto">
                 <div className="flex items-center gap-2">
                     <div onClick={() => setIsAchievementModalOpen(true)} className="relative bg-slate-800 border-2 border-yellow-600 rounded-lg px-4 py-2 flex items-center gap-3 shadow-lg cursor-pointer hover:bg-slate-700 active:scale-95 transition-all">
                        <div className="bg-yellow-500 rounded-full p-1"><Trophy size={16} className="text-black" /></div><span className="font-display text-yellow-500 text-xl tracking-wider">ë ˆë²¨ {level}</span><span className="text-xs text-gray-400 ml-1">/ {DIFFICULTY_SETTINGS[difficulty].maxLevel}</span>
                        {hasClaimableAchievements && (<span className="absolute -top-1 -right-1 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span></span>)}
                     </div>
                     <button onClick={() => { setIsHelpModalOpen(true); setSelectedUnit(null); }} className="bg-slate-800 p-2 rounded-full border-2 border-gray-500 text-gray-400 hover:text-white hover:border-white transition-all shadow-lg active:scale-95"><HelpCircle size={22} /></button>
                 </div>
            </div>
            <div className="flex items-center gap-3 pointer-events-auto">
                 <button onClick={canClaimSupply ? claimSupply : undefined} className={`relative bg-slate-800 border-2 border-blue-400 rounded-full px-3 py-1 flex items-center gap-2 shadow-lg transition-all ${canClaimSupply ? 'animate-bounce cursor-pointer hover:bg-slate-700' : 'opacity-70'}`}><Gift className={canClaimSupply ? "text-blue-300" : "text-gray-500"} size={20} />{canClaimSupply && <span className="absolute -top-1 -right-1 flex h-3 w-3"><span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span><span className="relative inline-flex rounded-full h-3 w-3 bg-blue-500"></span></span>}</button>
                 <div className="bg-slate-800 border-2 border-yellow-500 rounded-full px-4 py-1 flex items-center gap-2 shadow-lg"><Coins className="text-yellow-400" size={20} /><span className="font-bold text-white text-lg">{coins}</span></div>
            </div>
          </div>

          <div className="flex-1 w-full flex items-center justify-center overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')]">
            {loadingLevel && (<div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm"><RefreshCw className="animate-spin text-white mb-4" size={48} /><div className="font-display text-2xl tracking-widest">ì „ì¥ ìƒì„± ì¤‘...</div></div>)}
            {(phase === GamePhase.VICTORY || phase === GamePhase.DEFEAT) && (
                <div className="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/80 animate-in fade-in duration-500">
                    {phase === GamePhase.VICTORY ? (<><Trophy className="text-yellow-400 w-24 h-24 mb-6 animate-bounce" /><h1 className="font-display text-6xl text-yellow-400 mb-8 drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]">ìŠ¹ë¦¬</h1><button onClick={nextLevel} className="bg-yellow-500 hover:bg-yellow-400 text-black font-black text-2xl py-4 px-12 rounded-xl shadow-[0_0_20px_rgba(234,179,8,0.6)] transform hover:scale-110 transition-all active:scale-95">ë‹¤ìŒ ë‹¨ê³„</button></>) : (<><Skull className="text-red-500 w-24 h-24 mb-6" /><h1 className="font-display text-6xl text-red-600 mb-8">íŒ¨ë°°</h1><button onClick={retryLevel} className="bg-gray-700 hover:bg-gray-600 text-white font-bold text-xl py-3 px-10 rounded-xl border-2 border-gray-500 transform hover:scale-105 transition-all">ë‹¤ì‹œ ë„ì „</button></>)}
                </div>
            )}
            <div className="perspective-container w-full max-w-lg aspect-[7/8]">
              <div ref={gridRef} className="battle-grid relative w-full h-full bg-slate-800 border-4 border-slate-700 rounded-lg">
                 <div className="absolute inset-0 grid" style={{ gridTemplateColumns: `repeat(${GRID_COLS}, 1fr)`, gridTemplateRows: `repeat(${GRID_ROWS}, 1fr)` }}>{renderTiles()}</div>
                 {entities.map(entity => {
                    if (entity.id === draggingId) return null;
                    const left = (entity.x / GRID_COLS) * 100;
                    const top = (entity.y / GRID_ROWS) * 100;
                    return (<Unit key={entity.id} entity={entity} tileSize={gridRef.current ? gridRef.current.clientWidth / GRID_COLS : TILE_SIZE} style={{ left: `${left}%`, top: `${top}%` }} onMouseDown={(e) => handleMouseDown(e, entity)} onTouchStart={(e) => handleTouchStart(e, entity)} showHealth={phase === GamePhase.BATTLE} />);
                 })}
              </div>
            </div>
          </div>
          {draggingId && dragPos && (() => {
             const entity = entities.find(e => e.id === draggingId);
             if (!entity) return null;
             const tileSize = gridRef.current ? gridRef.current.clientWidth / GRID_COLS : TILE_SIZE;
             return (<div style={{ position: 'fixed', left: dragPos.x, top: dragPos.y, pointerEvents: 'none', zIndex: 9999 }}><Unit entity={entity} tileSize={tileSize} isDragging={true} style={{ position: 'relative', left: 0, top: 0 }} /></div>);
          })()}

          <div className="w-full h-32 sm:h-40 bg-slate-900 border-t-4 border-slate-800 flex items-center justify-center relative z-40 px-2 pb-safe">
            {phase === GamePhase.PREPARATION ? (
                <div className="w-full max-w-lg flex justify-between items-end pb-2 sm:pb-4 relative">
                    <div className="flex gap-2 sm:gap-4 items-end"><StoreCard cost={recruitCost} onBuy={() => setIsShopModalOpen(true)} canAfford={true} unitCount={entities.filter(e => e.side === Side.PLAYER).length}/><div className="absolute left-6 top-0 bg-slate-900 text-white text-[10px] px-1 rounded border border-gray-600 z-50">{entities.filter(e => e.side === Side.PLAYER).length} / {maxUnitCap}</div><ArtifactCard onOpen={() => setIsArtifactModalOpen(true)} /></div>
                    <div className="absolute left-1/2 transform -translate-x-1/2 -translate-y-6 sm:-translate-y-8 z-10"><button onClick={() => setPhase(GamePhase.BATTLE)} className="group relative w-24 h-24 sm:w-32 sm:h-32 rounded-full bg-gradient-to-br from-yellow-400 to-yellow-600 border-4 border-yellow-200 shadow-[0_0_30px_rgba(234,179,8,0.4)] flex flex-col items-center justify-center transition-all hover:scale-105 active:scale-95"><Swords size={32} className="sm:w-12 sm:h-12 text-yellow-900 drop-shadow-sm group-hover:animate-pulse" /><span className="font-display text-yellow-900 font-bold text-xs sm:text-lg mt-1">ì „íˆ¬ ì‹œì‘</span><span className="absolute inset-0 rounded-full border-4 border-yellow-400 opacity-0 group-hover:animate-ping"></span></button></div>
                    <div className="flex gap-2 sm:gap-4 items-end"><AltarCard onOpen={() => setIsAltarModalOpen(true)} /><UpgradeCard onOpen={() => setIsUpgradeModalOpen(true)} hasUpgradable={Object.values(UnitType).some(t => coins >= (TECH_COST_BASE + (techLevels[t] - 1) * TECH_COST_INCREASE))}/></div>
                </div>
            ) : (<div className="w-full flex justify-center items-center pb-4 text-slate-500 font-display text-xl tracking-widest animate-pulse">ì „íˆ¬ ì§„í–‰ ì¤‘...</div>)}
          </div>
        </div>
      );
    };

    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(<React.StrictMode><App /></React.StrictMode>);
    </script>
  </body>
</html>